{"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/index.ts":{"path":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/index.ts","statementMap":{"0":{"start":{"line":2,"column":22},"end":{"line":4,"column":1}},"1":{"start":{"line":3,"column":4},"end":{"line":3,"column":62}},"2":{"start":{"line":5,"column":0},"end":{"line":5,"column":62}},"3":{"start":{"line":6,"column":0},"end":{"line":6,"column":21}},"4":{"start":{"line":7,"column":17},"end":{"line":7,"column":51}},"5":{"start":{"line":8,"column":0},"end":{"line":8,"column":26}},"6":{"start":{"line":9,"column":23},"end":{"line":9,"column":48}},"7":{"start":{"line":10,"column":0},"end":{"line":10,"column":56}},"8":{"start":{"line":11,"column":18},"end":{"line":11,"column":53}},"9":{"start":{"line":12,"column":0},"end":{"line":12,"column":32}},"10":{"start":{"line":13,"column":15},"end":{"line":13,"column":47}},"11":{"start":{"line":14,"column":30},"end":{"line":14,"column":77}},"12":{"start":{"line":15,"column":13},"end":{"line":15,"column":28}},"13":{"start":{"line":16,"column":17},"end":{"line":16,"column":48}},"14":{"start":{"line":17,"column":17},"end":{"line":17,"column":60}},"15":{"start":{"line":18,"column":13},"end":{"line":18,"column":36}},"16":{"start":{"line":19,"column":16},"end":{"line":19,"column":42}},"17":{"start":{"line":20,"column":46},"end":{"line":20,"column":57}},"18":{"start":{"line":21,"column":20},"end":{"line":21,"column":62}},"19":{"start":{"line":22,"column":0},"end":{"line":22,"column":20}},"20":{"start":{"line":23,"column":0},"end":{"line":23,"column":39}},"21":{"start":{"line":24,"column":0},"end":{"line":24,"column":42}},"22":{"start":{"line":25,"column":0},"end":{"line":25,"column":39}},"23":{"start":{"line":26,"column":0},"end":{"line":26,"column":65}},"24":{"start":{"line":27,"column":0},"end":{"line":46,"column":3}},"25":{"start":{"line":28,"column":4},"end":{"line":45,"column":7}},"26":{"start":{"line":47,"column":0},"end":{"line":47,"column":45}},"27":{"start":{"line":49,"column":0},"end":{"line":49,"column":46}},"28":{"start":{"line":51,"column":0},"end":{"line":57,"column":3}},"29":{"start":{"line":52,"column":4},"end":{"line":52,"column":25}},"30":{"start":{"line":53,"column":48},"end":{"line":53,"column":53}},"31":{"start":{"line":54,"column":4},"end":{"line":55,"column":25}},"32":{"start":{"line":55,"column":8},"end":{"line":55,"column":25}},"33":{"start":{"line":56,"column":4},"end":{"line":56,"column":41}},"34":{"start":{"line":59,"column":0},"end":{"line":61,"column":3}},"35":{"start":{"line":60,"column":4},"end":{"line":60,"column":59}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":2,"column":56},"end":{"line":2,"column":57}},"loc":{"start":{"line":2,"column":71},"end":{"line":4,"column":1}},"line":2},"1":{"name":"(anonymous_1)","decl":{"start":{"line":27,"column":21},"end":{"line":27,"column":22}},"loc":{"start":{"line":27,"column":35},"end":{"line":46,"column":1}},"line":27},"2":{"name":"(anonymous_2)","decl":{"start":{"line":51,"column":16},"end":{"line":51,"column":17}},"loc":{"start":{"line":51,"column":43},"end":{"line":57,"column":1}},"line":51},"3":{"name":"(anonymous_3)","decl":{"start":{"line":59,"column":29},"end":{"line":59,"column":30}},"loc":{"start":{"line":59,"column":35},"end":{"line":61,"column":1}},"line":59}},"branchMap":{"0":{"loc":{"start":{"line":2,"column":22},"end":{"line":4,"column":1}},"type":"binary-expr","locations":[{"start":{"line":2,"column":23},"end":{"line":2,"column":27}},{"start":{"line":2,"column":31},"end":{"line":2,"column":51}},{"start":{"line":2,"column":56},"end":{"line":4,"column":1}}],"line":2},"1":{"loc":{"start":{"line":3,"column":11},"end":{"line":3,"column":61}},"type":"cond-expr","locations":[{"start":{"line":3,"column":37},"end":{"line":3,"column":40}},{"start":{"line":3,"column":43},"end":{"line":3,"column":61}}],"line":3},"2":{"loc":{"start":{"line":3,"column":12},"end":{"line":3,"column":33}},"type":"binary-expr","locations":[{"start":{"line":3,"column":12},"end":{"line":3,"column":15}},{"start":{"line":3,"column":19},"end":{"line":3,"column":33}}],"line":3},"3":{"loc":{"start":{"line":20,"column":8},"end":{"line":20,"column":21}},"type":"default-arg","locations":[{"start":{"line":20,"column":19},"end":{"line":20,"column":21}}],"line":20},"4":{"loc":{"start":{"line":36,"column":17},"end":{"line":43,"column":13}},"type":"cond-expr","locations":[{"start":{"line":37,"column":14},"end":{"line":40,"column":13}},{"start":{"line":41,"column":14},"end":{"line":43,"column":13}}],"line":36},"5":{"loc":{"start":{"line":53,"column":10},"end":{"line":53,"column":26}},"type":"default-arg","locations":[{"start":{"line":53,"column":23},"end":{"line":53,"column":26}}],"line":53},"6":{"loc":{"start":{"line":53,"column":28},"end":{"line":53,"column":43}},"type":"default-arg","locations":[{"start":{"line":53,"column":38},"end":{"line":53,"column":43}}],"line":53},"7":{"loc":{"start":{"line":54,"column":4},"end":{"line":55,"column":25}},"type":"if","locations":[{"start":{"line":54,"column":4},"end":{"line":55,"column":25}},{"start":{"line":54,"column":4},"end":{"line":55,"column":25}}],"line":54},"8":{"loc":{"start":{"line":54,"column":8},"end":{"line":54,"column":45}},"type":"binary-expr","locations":[{"start":{"line":54,"column":8},"end":{"line":54,"column":25}},{"start":{"line":54,"column":29},"end":{"line":54,"column":45}}],"line":54}},"s":{"0":1,"1":5,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1,"9":1,"10":1,"11":1,"12":1,"13":1,"14":1,"15":1,"16":1,"17":1,"18":1,"19":1,"20":1,"21":1,"22":1,"23":1,"24":1,"25":0,"26":1,"27":1,"28":1,"29":0,"30":0,"31":0,"32":0,"33":0,"34":1,"35":1},"f":{"0":5,"1":0,"2":0,"3":1},"b":{"0":[1,1,1],"1":[1,4],"2":[5,5],"3":[0],"4":[0,0],"5":[0],"6":[0],"7":[0,0],"8":[0,0]},"inputSourceMap":{"version":3,"file":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/index.ts","sources":["/mnt/ironwolf2tb/moreillon/dev/node/image_manager/index.ts"],"names":[],"mappings":";;;;;;AAAA,oDAA2B;AAC3B,gBAAM,CAAC,MAAM,EAAE,CAAA;AAEf,iDAAgD;AAChD,OAAO,CAAC,GAAG,CAAC,kBAAkB,sBAAO,EAAE,CAAC,CAAA;AAExC,sDAA6B;AAC7B,gCAA6B;AAC7B,gDAAuB;AACvB,8EAA4C;AAC5C,6BAIa;AACb,iDAAgD;AAChD,6DAA2C;AAE3C,qCAA+D;AAC/D,2CAAmD;AAEnD,MAAM,EAAE,QAAQ,GAAG,EAAE,EAAE,kBAAkB,EAAE,GAAG,OAAO,CAAC,GAAG,CAAA;AACzD,MAAM,WAAW,GAAG,EAAE,aAAa,EAAE,IAAI,EAAE,WAAW,EAAE,IAAI,EAAE,CAAA;AAE9D,IAAA,YAAU,GAAE,CAAA;AAEC,QAAA,GAAG,GAAG,IAAA,iBAAO,GAAE,CAAA;AAC5B,WAAG,CAAC,GAAG,CAAC,iBAAO,CAAC,IAAI,EAAE,CAAC,CAAA;AACvB,WAAG,CAAC,GAAG,CAAC,IAAA,cAAI,GAAE,CAAC,CAAA;AACf,WAAG,CAAC,GAAG,CAAC,IAAA,6BAAU,EAAC,WAAW,CAAC,CAAC,CAAA;AAChC,WAAG,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE;IACxB,GAAG,CAAC,IAAI,CAAC;QACP,gBAAgB,EAAE,mBAAmB;QACrC,MAAM,EAAN,qBAAM;QACN,OAAO,EAAP,sBAAO;QACP,OAAO,EAAE;YACP,iBAAiB,EAAE,6BAAkB;YACrC,SAAS,EAAE,IAAA,kBAAa,GAAE;SAC3B;QACD,OAAO,EAAE,aAAQ;YACf,CAAC,CAAC;gBACE,MAAM,EAAE,cAAS;gBACjB,QAAQ,EAAE,gBAAW;aACtB;YACH,CAAC,CAAC;gBACE,SAAS,EAAE,yBAAiB;aAC7B;QACL,IAAI,EAAE,EAAE,kBAAkB,EAAE,kBAAkB,EAAE;KACjD,CAAC,CAAA;AACJ,CAAC,CAAC,CAAA;AAEF,WAAG,CAAC,GAAG,CAAC,SAAS,EAAE,gBAAa,CAAC,CAAA;AAEjC,SAAS;AACT,WAAG,CAAC,GAAG,CAAC,QAAQ,EAAE,kBAAS,CAAC,CAAA;AAE5B,wBAAwB;AACxB,WAAG,CAAC,GAAG,CAAC,CAAC,KAAU,EAAE,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;IACtE,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,CAAA;IACpB,IAAI,EAAE,UAAU,GAAG,GAAG,EAAE,OAAO,GAAG,KAAK,EAAE,GAAG,KAAK,CAAA;IACjD,IAAI,KAAK,CAAC,UAAU,CAAC,IAAI,UAAU,GAAG,GAAG;QAAE,UAAU,GAAG,GAAG,CAAA;IAC3D,GAAG,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,CAAA;AACtC,CAAC,CAAC,CAAA;AAEF,eAAe;AACf,WAAG,CAAC,MAAM,CAAC,QAAQ,EAAE,GAAG,EAAE;IACxB,OAAO,CAAC,GAAG,CAAC,+BAA+B,QAAQ,EAAE,CAAC,CAAA;AACxD,CAAC,CAAC,CAAA","sourcesContent":["import dotenv from \"dotenv\"\r\ndotenv.config()\r\n\r\nimport { version, author } from \"./package.json\"\r\nconsole.log(`Image manager v${version}`)\r\n\r\nimport express from \"express\"\r\nimport \"express-async-errors\"\r\nimport cors from \"cors\"\r\nimport promBundle from \"express-prom-bundle\"\r\nimport {\r\n  get_connected,\r\n  redactedConnectionString as dbConnectionString,\r\n  connect as db_connect,\r\n} from \"./db\"\r\nimport { get_image } from \"./controllers/images\"\r\nimport images_router from \"./routes/images\"\r\nimport { Request, Response, NextFunction } from \"express\"\r\nimport { s3Client, S3_BUCKET, S3_ENDPOINT } from \"./storage/s3\"\r\nimport { UPLOADS_DIRECTORY } from \"./storage/local\"\r\n\r\nconst { APP_PORT = 80, IDENTIFICATION_URL } = process.env\r\nconst promOptions = { includeMethod: true, includePath: true }\r\n\r\ndb_connect()\r\n\r\nexport const app = express()\r\napp.use(express.json())\r\napp.use(cors())\r\napp.use(promBundle(promOptions))\r\napp.get(\"/\", (req, res) => {\r\n  res.send({\r\n    application_name: \"Image manager API\",\r\n    author,\r\n    version,\r\n    mongodb: {\r\n      connection_string: dbConnectionString,\r\n      connected: get_connected(),\r\n    },\r\n    storage: s3Client\r\n      ? {\r\n          bucket: S3_BUCKET,\r\n          endpoint: S3_ENDPOINT,\r\n        }\r\n      : {\r\n          directory: UPLOADS_DIRECTORY,\r\n        },\r\n    auth: { identification_url: IDENTIFICATION_URL },\r\n  })\r\n})\r\n\r\napp.use(\"/images\", images_router)\r\n\r\n// Legacy\r\napp.get(\"/image\", get_image)\r\n\r\n// Express error handler\r\napp.use((error: any, req: Request, res: Response, next: NextFunction) => {\r\n  console.error(error)\r\n  let { statusCode = 500, message = error } = error\r\n  if (isNaN(statusCode) || statusCode > 600) statusCode = 500\r\n  res.status(statusCode).send(message)\r\n})\r\n\r\n// Start server\r\napp.listen(APP_PORT, () => {\r\n  console.log(`[Express] listening on port ${APP_PORT}`)\r\n})\r\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"99a84c2632e4de7f5a13c07ef9c6e6a6694d15a0","contentHash":"3452d1541cff730ed300227f6c07f5fc568e5da1d5f4a9df681cda68aa636bfb"},"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/db.ts":{"path":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/db.ts","statementMap":{"0":{"start":{"line":2,"column":22},"end":{"line":4,"column":1}},"1":{"start":{"line":3,"column":4},"end":{"line":3,"column":62}},"2":{"start":{"line":6,"column":0},"end":{"line":6,"column":62}},"3":{"start":{"line":7,"column":0},"end":{"line":7,"column":321}},"4":{"start":{"line":8,"column":19},"end":{"line":8,"column":55}},"5":{"start":{"line":9,"column":0},"end":{"line":9,"column":527}},"6":{"start":{"line":10,"column":24},"end":{"line":13,"column":1}},"7":{"start":{"line":14,"column":20},"end":{"line":14,"column":74}},"8":{"start":{"line":15,"column":0},"end":{"line":18,"column":129}},"9":{"start":{"line":19,"column":0},"end":{"line":19,"column":91}},"10":{"start":{"line":20,"column":16},"end":{"line":33,"column":2}},"11":{"start":{"line":20,"column":22},"end":{"line":33,"column":2}},"12":{"start":{"line":21,"column":4},"end":{"line":21,"column":54}},"13":{"start":{"line":22,"column":4},"end":{"line":32,"column":7}},"14":{"start":{"line":25,"column":8},"end":{"line":25,"column":22}},"15":{"start":{"line":26,"column":8},"end":{"line":26,"column":64}},"16":{"start":{"line":29,"column":8},"end":{"line":29,"column":60}},"17":{"start":{"line":30,"column":8},"end":{"line":30,"column":29}},"18":{"start":{"line":31,"column":8},"end":{"line":31,"column":42}},"19":{"start":{"line":34,"column":0},"end":{"line":34,"column":26}},"20":{"start":{"line":35,"column":11},"end":{"line":35,"column":40}},"21":{"start":{"line":36,"column":0},"end":{"line":38,"column":3}},"22":{"start":{"line":37,"column":4},"end":{"line":37,"column":46}},"23":{"start":{"line":39,"column":0},"end":{"line":41,"column":3}},"24":{"start":{"line":40,"column":4},"end":{"line":40,"column":53}},"25":{"start":{"line":42,"column":22},"end":{"line":42,"column":68}},"26":{"start":{"line":42,"column":28},"end":{"line":42,"column":68}},"27":{"start":{"line":43,"column":0},"end":{"line":43,"column":38}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":2,"column":56},"end":{"line":2,"column":57}},"loc":{"start":{"line":2,"column":71},"end":{"line":4,"column":1}},"line":2},"1":{"name":"(anonymous_1)","decl":{"start":{"line":20,"column":16},"end":{"line":20,"column":17}},"loc":{"start":{"line":20,"column":22},"end":{"line":33,"column":2}},"line":20},"2":{"name":"(anonymous_2)","decl":{"start":{"line":20,"column":34},"end":{"line":20,"column":35}},"loc":{"start":{"line":20,"column":47},"end":{"line":33,"column":1}},"line":20},"3":{"name":"(anonymous_3)","decl":{"start":{"line":24,"column":14},"end":{"line":24,"column":15}},"loc":{"start":{"line":24,"column":20},"end":{"line":27,"column":5}},"line":24},"4":{"name":"(anonymous_4)","decl":{"start":{"line":28,"column":15},"end":{"line":28,"column":16}},"loc":{"start":{"line":28,"column":26},"end":{"line":32,"column":5}},"line":28},"5":{"name":"(anonymous_5)","decl":{"start":{"line":36,"column":15},"end":{"line":36,"column":16}},"loc":{"start":{"line":36,"column":21},"end":{"line":38,"column":1}},"line":36},"6":{"name":"(anonymous_6)","decl":{"start":{"line":39,"column":16},"end":{"line":39,"column":17}},"loc":{"start":{"line":39,"column":22},"end":{"line":41,"column":1}},"line":39},"7":{"name":"(anonymous_7)","decl":{"start":{"line":42,"column":22},"end":{"line":42,"column":23}},"loc":{"start":{"line":42,"column":28},"end":{"line":42,"column":68}},"line":42}},"branchMap":{"0":{"loc":{"start":{"line":2,"column":22},"end":{"line":4,"column":1}},"type":"binary-expr","locations":[{"start":{"line":2,"column":23},"end":{"line":2,"column":27}},{"start":{"line":2,"column":31},"end":{"line":2,"column":51}},{"start":{"line":2,"column":56},"end":{"line":4,"column":1}}],"line":2},"1":{"loc":{"start":{"line":3,"column":11},"end":{"line":3,"column":61}},"type":"cond-expr","locations":[{"start":{"line":3,"column":37},"end":{"line":3,"column":40}},{"start":{"line":3,"column":43},"end":{"line":3,"column":61}}],"line":3},"2":{"loc":{"start":{"line":3,"column":12},"end":{"line":3,"column":33}},"type":"binary-expr","locations":[{"start":{"line":3,"column":12},"end":{"line":3,"column":15}},{"start":{"line":3,"column":19},"end":{"line":3,"column":33}}],"line":3},"3":{"loc":{"start":{"line":9,"column":137},"end":{"line":9,"column":167}},"type":"cond-expr","locations":[{"start":{"line":9,"column":153},"end":{"line":9,"column":162}},{"start":{"line":9,"column":165},"end":{"line":9,"column":167}}],"line":9},"4":{"loc":{"start":{"line":9,"column":310},"end":{"line":9,"column":338}},"type":"cond-expr","locations":[{"start":{"line":9,"column":326},"end":{"line":9,"column":333}},{"start":{"line":9,"column":336},"end":{"line":9,"column":338}}],"line":9},"5":{"loc":{"start":{"line":9,"column":421},"end":{"line":9,"column":450}},"type":"cond-expr","locations":[{"start":{"line":9,"column":437},"end":{"line":9,"column":445}},{"start":{"line":9,"column":448},"end":{"line":9,"column":450}}],"line":9},"6":{"loc":{"start":{"line":9,"column":503},"end":{"line":9,"column":526}},"type":"cond-expr","locations":[{"start":{"line":9,"column":519},"end":{"line":9,"column":521}},{"start":{"line":9,"column":524},"end":{"line":9,"column":526}}],"line":9},"7":{"loc":{"start":{"line":14,"column":20},"end":{"line":14,"column":74}},"type":"cond-expr","locations":[{"start":{"line":14,"column":43},"end":{"line":14,"column":69}},{"start":{"line":14,"column":72},"end":{"line":14,"column":74}}],"line":14},"8":{"loc":{"start":{"line":15,"column":27},"end":{"line":18,"column":128}},"type":"binary-expr","locations":[{"start":{"line":15,"column":27},"end":{"line":15,"column":60}},{"start":{"line":16,"column":5},"end":{"line":18,"column":127}}],"line":15},"9":{"loc":{"start":{"line":16,"column":5},"end":{"line":18,"column":127}},"type":"cond-expr","locations":[{"start":{"line":17,"column":10},"end":{"line":17,"column":183}},{"start":{"line":18,"column":10},"end":{"line":18,"column":127}}],"line":16},"10":{"loc":{"start":{"line":16,"column":5},"end":{"line":16,"column":57}},"type":"binary-expr","locations":[{"start":{"line":16,"column":5},"end":{"line":16,"column":29}},{"start":{"line":16,"column":33},"end":{"line":16,"column":57}}],"line":16}},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1,"9":1,"10":1,"11":1,"12":1,"13":1,"14":1,"15":1,"16":0,"17":0,"18":0,"19":1,"20":1,"21":1,"22":0,"23":1,"24":1,"25":1,"26":0,"27":1},"f":{"0":1,"1":1,"2":1,"3":1,"4":0,"5":0,"6":1,"7":0},"b":{"0":[1,1,1],"1":[0,1],"2":[1,1],"3":[1,0],"4":[1,0],"5":[1,0],"6":[1,0],"7":[0,1],"8":[1,0],"9":[0,0],"10":[0,0]},"inputSourceMap":{"version":3,"file":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/db.ts","sources":["/mnt/ironwolf2tb/moreillon/dev/node/image_manager/db.ts"],"names":[],"mappings":";;;;;;;AAAA,wDAA+B;AAElB,KAST,OAAO,CAAC,GAAG,EARb,iCAAyB,iCACzB,wBAA4B,EAA5B,wBAAgB,mBAAG,SAAS,OAC5B,wBAAgB,wBAChB,wBAAgB,wBAChB,oBAAsB,EAAtB,oBAAY,mBAAG,OAAO,OACtB,oBAAY,oBACZ,kBAAqB,EAArB,kBAAU,mBAAG,QAAQ,OACrB,uBAAoB,EAApB,uBAAe,mBAAG,EAAE,MACP;AAEf,MAAM,eAAe,GAAG;IACtB,kBAAkB,EAAE,IAAI;IACxB,eAAe,EAAE,IAAI;CACtB,CAAA;AAED,MAAM,WAAW,GAAG,oBAAY,CAAC,CAAC,CAAC,IAAI,oBAAY,EAAE,CAAC,CAAC,CAAC,EAAE,CAAA;AAE7C,QAAA,gBAAgB,GAC3B,iCAAyB;IACzB,CAAC,wBAAgB,IAAI,wBAAgB;QACnC,CAAC,CAAC,GAAG,wBAAgB,MAAM,wBAAgB,IAAI,wBAAgB,IAAI,oBAAY,GAAG,WAAW,IAAI,kBAAU,GAAG,uBAAe,EAAE;QAC/H,CAAC,CAAC,GAAG,wBAAgB,MAAM,oBAAY,GAAG,WAAW,IAAI,kBAAU,GAAG,uBAAe,EAAE,CAAC,CAAA;AAE/E,QAAA,wBAAwB,GAAG,wBAAgB,CAAC,OAAO,CAC9D,MAAM,EACN,aAAa,CACd,CAAA;AAEM,MAAM,OAAO,GAAG,GAAG,EAAE,CAC1B,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;IACtB,OAAO,CAAC,GAAG,CAAC,oCAAoC,CAAC,CAAA;IACjD,kBAAQ;SACL,OAAO,CAAC,wBAAgB,EAAE,eAAe,CAAC;SAC1C,IAAI,CAAC,GAAG,EAAE;QACT,OAAO,CAAC,IAAI,CAAC,CAAA;QACb,OAAO,CAAC,GAAG,CAAC,0CAA0C,CAAC,CAAA;IACzD,CAAC,CAAC;SACD,KAAK,CAAC,CAAC,KAAK,EAAE,EAAE;QACf,OAAO,CAAC,GAAG,CAAC,sCAAsC,CAAC,CAAA;QACnD,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,CAAA;QACpB,UAAU,CAAC,eAAO,EAAE,IAAI,CAAC,CAAA;IAC3B,CAAC,CAAC,CAAA;AACN,CAAC,CAAC,CAAA;AAdS,QAAA,OAAO,WAchB;AAEJ,MAAM,EAAE,GAAG,kBAAQ,CAAC,UAAU,CAAA;AAC9B,EAAE,CAAC,EAAE,CAAC,OAAO,EAAE,GAAG,EAAE;IAClB,OAAO,CAAC,GAAG,CAAC,4BAA4B,CAAC,CAAA;AAC3C,CAAC,CAAC,CAAA;AACF,EAAE,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,EAAE;IACnB,OAAO,CAAC,GAAG,CAAC,mCAAmC,CAAC,CAAA;AAClD,CAAC,CAAC,CAAA;AAEK,MAAM,aAAa,GAAG,GAAG,EAAE,CAAC,kBAAQ,CAAC,UAAU,CAAC,UAAU,CAAA;AAApD,QAAA,aAAa,iBAAuC","sourcesContent":["import mongoose from \"mongoose\"\r\n\r\nexport const {\r\n  MONGODB_CONNECTION_STRING,\r\n  MONGODB_PROTOCOL = \"mongodb\",\r\n  MONGODB_USERNAME,\r\n  MONGODB_PASSWORD,\r\n  MONGODB_HOST = \"mongo\",\r\n  MONGODB_PORT,\r\n  MONGODB_DB = \"images\",\r\n  MONGODB_OPTIONS = \"\",\r\n} = process.env\r\n\r\nconst mongodb_options = {\r\n  useUnifiedTopology: true,\r\n  useNewUrlParser: true,\r\n}\r\n\r\nconst mongodbPort = MONGODB_PORT ? `:${MONGODB_PORT}` : \"\"\r\n\r\nexport const connectionString =\r\n  MONGODB_CONNECTION_STRING ||\r\n  (MONGODB_USERNAME && MONGODB_PASSWORD\r\n    ? `${MONGODB_PROTOCOL}://${MONGODB_USERNAME}:${MONGODB_PASSWORD}@${MONGODB_HOST}${mongodbPort}/${MONGODB_DB}${MONGODB_OPTIONS}`\r\n    : `${MONGODB_PROTOCOL}://${MONGODB_HOST}${mongodbPort}/${MONGODB_DB}${MONGODB_OPTIONS}`)\r\n\r\nexport const redactedConnectionString = connectionString.replace(\r\n  /:.*@/,\r\n  \"://***:***@\"\r\n)\r\n\r\nexport const connect = () =>\r\n  new Promise((resolve) => {\r\n    console.log(\"[MongoDB] Attempting connection...\")\r\n    mongoose\r\n      .connect(connectionString, mongodb_options)\r\n      .then(() => {\r\n        resolve(null)\r\n        console.log(\"[Mongoose] Initial connection successful\")\r\n      })\r\n      .catch((error) => {\r\n        console.log(\"[Mongoose] Initial connection failed\")\r\n        console.error(error)\r\n        setTimeout(connect, 5000)\r\n      })\r\n  })\r\n\r\nconst db = mongoose.connection\r\ndb.on(\"error\", () => {\r\n  console.log(\"[Mongoose] Connection lost\")\r\n})\r\ndb.once(\"open\", () => {\r\n  console.log(\"[Mongoose] Connection established\")\r\n})\r\n\r\nexport const get_connected = () => mongoose.connection.readyState\r\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"03e344d9cbfa1f9c257c0a562eabba3464e5a52d","contentHash":"6544e0c9119ee0885e59b099da87d222bfda46f8b1b4d951e7da902c5c76fa4d"},"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/controllers/images.ts":{"path":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/controllers/images.ts","statementMap":{"0":{"start":{"line":2,"column":16},"end":{"line":10,"column":1}},"1":{"start":{"line":3,"column":28},"end":{"line":3,"column":110}},"2":{"start":{"line":3,"column":91},"end":{"line":3,"column":106}},"3":{"start":{"line":4,"column":4},"end":{"line":9,"column":7}},"4":{"start":{"line":5,"column":36},"end":{"line":5,"column":97}},"5":{"start":{"line":5,"column":42},"end":{"line":5,"column":70}},"6":{"start":{"line":5,"column":85},"end":{"line":5,"column":95}},"7":{"start":{"line":6,"column":35},"end":{"line":6,"column":100}},"8":{"start":{"line":6,"column":41},"end":{"line":6,"column":73}},"9":{"start":{"line":6,"column":88},"end":{"line":6,"column":98}},"10":{"start":{"line":7,"column":32},"end":{"line":7,"column":116}},"11":{"start":{"line":8,"column":8},"end":{"line":8,"column":78}},"12":{"start":{"line":11,"column":22},"end":{"line":13,"column":1}},"13":{"start":{"line":12,"column":4},"end":{"line":12,"column":62}},"14":{"start":{"line":14,"column":0},"end":{"line":14,"column":62}},"15":{"start":{"line":15,"column":0},"end":{"line":15,"column":157}},"16":{"start":{"line":16,"column":16},"end":{"line":16,"column":59}},"17":{"start":{"line":17,"column":22},"end":{"line":17,"column":61}},"18":{"start":{"line":18,"column":16},"end":{"line":18,"column":35}},"19":{"start":{"line":19,"column":16},"end":{"line":19,"column":43}},"20":{"start":{"line":20,"column":13},"end":{"line":20,"column":37}},"21":{"start":{"line":21,"column":29},"end":{"line":29,"column":1}},"22":{"start":{"line":22,"column":4},"end":{"line":23,"column":15}},"23":{"start":{"line":23,"column":8},"end":{"line":23,"column":15}},"24":{"start":{"line":24,"column":21},"end":{"line":24,"column":31}},"25":{"start":{"line":25,"column":53},"end":{"line":25,"column":57}},"26":{"start":{"line":26,"column":4},"end":{"line":28,"column":5}},"27":{"start":{"line":27,"column":8},"end":{"line":27,"column":92}},"28":{"start":{"line":30,"column":21},"end":{"line":30,"column":82}},"29":{"start":{"line":30,"column":30},"end":{"line":30,"column":82}},"30":{"start":{"line":31,"column":21},"end":{"line":43,"column":2}},"31":{"start":{"line":31,"column":35},"end":{"line":43,"column":2}},"32":{"start":{"line":33,"column":24},"end":{"line":33,"column":175}},"33":{"start":{"line":34,"column":95},"end":{"line":34,"column":129}},"34":{"start":{"line":35,"column":28},"end":{"line":36,"column":61}},"35":{"start":{"line":37,"column":19},"end":{"line":37,"column":64}},"36":{"start":{"line":38,"column":4},"end":{"line":41,"column":68}},"37":{"start":{"line":39,"column":8},"end":{"line":39,"column":63}},"38":{"start":{"line":41,"column":8},"end":{"line":41,"column":68}},"39":{"start":{"line":42,"column":4},"end":{"line":42,"column":21}},"40":{"start":{"line":44,"column":0},"end":{"line":44,"column":36}},"41":{"start":{"line":45,"column":23},"end":{"line":60,"column":2}},"42":{"start":{"line":45,"column":37},"end":{"line":60,"column":2}},"43":{"start":{"line":46,"column":80},"end":{"line":46,"column":89}},"44":{"start":{"line":47,"column":18},"end":{"line":47,"column":20}},"45":{"start":{"line":48,"column":4},"end":{"line":52,"column":5}},"46":{"start":{"line":49,"column":22},"end":{"line":49,"column":55}},"47":{"start":{"line":50,"column":37},"end":{"line":50,"column":64}},"48":{"start":{"line":51,"column":8},"end":{"line":51,"column":70}},"49":{"start":{"line":51,"column":53},"end":{"line":51,"column":67}},"50":{"start":{"line":53,"column":18},"end":{"line":56,"column":42}},"51":{"start":{"line":57,"column":18},"end":{"line":57,"column":61}},"52":{"start":{"line":58,"column":21},"end":{"line":58,"column":37}},"53":{"start":{"line":59,"column":4},"end":{"line":59,"column":23}},"54":{"start":{"line":61,"column":0},"end":{"line":61,"column":40}},"55":{"start":{"line":62,"column":26},"end":{"line":70,"column":2}},"56":{"start":{"line":62,"column":40},"end":{"line":70,"column":2}},"57":{"start":{"line":63,"column":21},"end":{"line":63,"column":38}},"58":{"start":{"line":64,"column":4},"end":{"line":65,"column":75}},"59":{"start":{"line":65,"column":8},"end":{"line":65,"column":75}},"60":{"start":{"line":66,"column":18},"end":{"line":66,"column":58}},"61":{"start":{"line":67,"column":4},"end":{"line":68,"column":71}},"62":{"start":{"line":68,"column":8},"end":{"line":68,"column":71}},"63":{"start":{"line":69,"column":4},"end":{"line":69,"column":20}},"64":{"start":{"line":71,"column":0},"end":{"line":71,"column":46}},"65":{"start":{"line":72,"column":18},"end":{"line":88,"column":2}},"66":{"start":{"line":72,"column":32},"end":{"line":88,"column":2}},"67":{"start":{"line":73,"column":21},"end":{"line":73,"column":38}},"68":{"start":{"line":74,"column":20},"end":{"line":74,"column":59}},"69":{"start":{"line":75,"column":4},"end":{"line":76,"column":81}},"70":{"start":{"line":76,"column":8},"end":{"line":76,"column":81}},"71":{"start":{"line":77,"column":18},"end":{"line":77,"column":58}},"72":{"start":{"line":78,"column":4},"end":{"line":79,"column":71}},"73":{"start":{"line":79,"column":8},"end":{"line":79,"column":71}},"74":{"start":{"line":80,"column":4},"end":{"line":80,"column":37}},"75":{"start":{"line":81,"column":27},"end":{"line":81,"column":85}},"76":{"start":{"line":81,"column":68},"end":{"line":81,"column":84}},"77":{"start":{"line":82,"column":21},"end":{"line":82,"column":108}},"78":{"start":{"line":83,"column":4},"end":{"line":86,"column":64}},"79":{"start":{"line":84,"column":8},"end":{"line":84,"column":63}},"80":{"start":{"line":86,"column":8},"end":{"line":86,"column":64}},"81":{"start":{"line":87,"column":4},"end":{"line":87,"column":27}},"82":{"start":{"line":89,"column":0},"end":{"line":89,"column":30}},"83":{"start":{"line":90,"column":29},"end":{"line":106,"column":2}},"84":{"start":{"line":90,"column":43},"end":{"line":106,"column":2}},"85":{"start":{"line":91,"column":21},"end":{"line":91,"column":31}},"86":{"start":{"line":92,"column":21},"end":{"line":92,"column":34}},"87":{"start":{"line":93,"column":4},"end":{"line":94,"column":78}},"88":{"start":{"line":94,"column":8},"end":{"line":94,"column":78}},"89":{"start":{"line":95,"column":20},"end":{"line":95,"column":51}},"90":{"start":{"line":96,"column":26},"end":{"line":96,"column":65}},"91":{"start":{"line":97,"column":4},"end":{"line":98,"column":75}},"92":{"start":{"line":98,"column":8},"end":{"line":98,"column":75}},"93":{"start":{"line":99,"column":27},"end":{"line":99,"column":35}},"94":{"start":{"line":100,"column":18},"end":{"line":100,"column":58}},"95":{"start":{"line":101,"column":4},"end":{"line":103,"column":5}},"96":{"start":{"line":102,"column":8},"end":{"line":102,"column":78}},"97":{"start":{"line":104,"column":25},"end":{"line":104,"column":142}},"98":{"start":{"line":105,"column":4},"end":{"line":105,"column":27}},"99":{"start":{"line":107,"column":0},"end":{"line":107,"column":52}},"100":{"start":{"line":108,"column":21},"end":{"line":132,"column":2}},"101":{"start":{"line":108,"column":35},"end":{"line":132,"column":2}},"102":{"start":{"line":109,"column":21},"end":{"line":109,"column":31}},"103":{"start":{"line":110,"column":4},"end":{"line":111,"column":78}},"104":{"start":{"line":111,"column":8},"end":{"line":111,"column":78}},"105":{"start":{"line":112,"column":20},"end":{"line":112,"column":51}},"106":{"start":{"line":113,"column":26},"end":{"line":113,"column":65}},"107":{"start":{"line":114,"column":21},"end":{"line":114,"column":38}},"108":{"start":{"line":115,"column":4},"end":{"line":116,"column":75}},"109":{"start":{"line":116,"column":8},"end":{"line":116,"column":75}},"110":{"start":{"line":117,"column":18},"end":{"line":117,"column":58}},"111":{"start":{"line":118,"column":4},"end":{"line":120,"column":5}},"112":{"start":{"line":119,"column":8},"end":{"line":119,"column":78}},"113":{"start":{"line":121,"column":4},"end":{"line":129,"column":5}},"114":{"start":{"line":122,"column":8},"end":{"line":125,"column":49}},"115":{"start":{"line":123,"column":12},"end":{"line":123,"column":46}},"116":{"start":{"line":125,"column":12},"end":{"line":125,"column":49}},"117":{"start":{"line":128,"column":8},"end":{"line":128,"column":27}},"118":{"start":{"line":130,"column":4},"end":{"line":130,"column":25}},"119":{"start":{"line":131,"column":4},"end":{"line":131,"column":27}},"120":{"start":{"line":133,"column":0},"end":{"line":133,"column":36}},"121":{"start":{"line":134,"column":19},"end":{"line":156,"column":2}},"122":{"start":{"line":134,"column":35},"end":{"line":156,"column":2}},"123":{"start":{"line":136,"column":4},"end":{"line":139,"column":24}},"124":{"start":{"line":137,"column":8},"end":{"line":137,"column":25}},"125":{"start":{"line":139,"column":8},"end":{"line":139,"column":24}},"126":{"start":{"line":141,"column":4},"end":{"line":141,"column":35}},"127":{"start":{"line":143,"column":24},"end":{"line":143,"column":43}},"128":{"start":{"line":144,"column":4},"end":{"line":154,"column":5}},"129":{"start":{"line":145,"column":28},"end":{"line":145,"column":81}},"130":{"start":{"line":145,"column":61},"end":{"line":145,"column":80}},"131":{"start":{"line":146,"column":8},"end":{"line":153,"column":9}},"132":{"start":{"line":147,"column":12},"end":{"line":147,"column":52}},"133":{"start":{"line":149,"column":12},"end":{"line":152,"column":15}},"134":{"start":{"line":155,"column":4},"end":{"line":155,"column":23}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":2,"column":44},"end":{"line":2,"column":45}},"loc":{"start":{"line":2,"column":89},"end":{"line":10,"column":1}},"line":2},"1":{"name":"adopt","decl":{"start":{"line":3,"column":13},"end":{"line":3,"column":18}},"loc":{"start":{"line":3,"column":26},"end":{"line":3,"column":112}},"line":3},"2":{"name":"(anonymous_2)","decl":{"start":{"line":3,"column":70},"end":{"line":3,"column":71}},"loc":{"start":{"line":3,"column":89},"end":{"line":3,"column":108}},"line":3},"3":{"name":"(anonymous_3)","decl":{"start":{"line":4,"column":36},"end":{"line":4,"column":37}},"loc":{"start":{"line":4,"column":63},"end":{"line":9,"column":5}},"line":4},"4":{"name":"fulfilled","decl":{"start":{"line":5,"column":17},"end":{"line":5,"column":26}},"loc":{"start":{"line":5,"column":34},"end":{"line":5,"column":99}},"line":5},"5":{"name":"rejected","decl":{"start":{"line":6,"column":17},"end":{"line":6,"column":25}},"loc":{"start":{"line":6,"column":33},"end":{"line":6,"column":102}},"line":6},"6":{"name":"step","decl":{"start":{"line":7,"column":17},"end":{"line":7,"column":21}},"loc":{"start":{"line":7,"column":30},"end":{"line":7,"column":118}},"line":7},"7":{"name":"(anonymous_7)","decl":{"start":{"line":11,"column":56},"end":{"line":11,"column":57}},"loc":{"start":{"line":11,"column":71},"end":{"line":13,"column":1}},"line":11},"8":{"name":"(anonymous_8)","decl":{"start":{"line":21,"column":29},"end":{"line":21,"column":30}},"loc":{"start":{"line":21,"column":45},"end":{"line":29,"column":1}},"line":21},"9":{"name":"(anonymous_9)","decl":{"start":{"line":30,"column":21},"end":{"line":30,"column":22}},"loc":{"start":{"line":30,"column":30},"end":{"line":30,"column":82}},"line":30},"10":{"name":"(anonymous_10)","decl":{"start":{"line":31,"column":21},"end":{"line":31,"column":22}},"loc":{"start":{"line":31,"column":35},"end":{"line":43,"column":2}},"line":31},"11":{"name":"(anonymous_11)","decl":{"start":{"line":31,"column":69},"end":{"line":31,"column":70}},"loc":{"start":{"line":31,"column":82},"end":{"line":43,"column":1}},"line":31},"12":{"name":"(anonymous_12)","decl":{"start":{"line":45,"column":23},"end":{"line":45,"column":24}},"loc":{"start":{"line":45,"column":37},"end":{"line":60,"column":2}},"line":45},"13":{"name":"(anonymous_13)","decl":{"start":{"line":45,"column":71},"end":{"line":45,"column":72}},"loc":{"start":{"line":45,"column":84},"end":{"line":60,"column":1}},"line":45},"14":{"name":"(anonymous_14)","decl":{"start":{"line":51,"column":45},"end":{"line":51,"column":46}},"loc":{"start":{"line":51,"column":53},"end":{"line":51,"column":67}},"line":51},"15":{"name":"(anonymous_15)","decl":{"start":{"line":62,"column":26},"end":{"line":62,"column":27}},"loc":{"start":{"line":62,"column":40},"end":{"line":70,"column":2}},"line":62},"16":{"name":"(anonymous_16)","decl":{"start":{"line":62,"column":74},"end":{"line":62,"column":75}},"loc":{"start":{"line":62,"column":87},"end":{"line":70,"column":1}},"line":62},"17":{"name":"(anonymous_17)","decl":{"start":{"line":72,"column":18},"end":{"line":72,"column":19}},"loc":{"start":{"line":72,"column":32},"end":{"line":88,"column":2}},"line":72},"18":{"name":"(anonymous_18)","decl":{"start":{"line":72,"column":66},"end":{"line":72,"column":67}},"loc":{"start":{"line":72,"column":79},"end":{"line":88,"column":1}},"line":72},"19":{"name":"(anonymous_19)","decl":{"start":{"line":81,"column":54},"end":{"line":81,"column":55}},"loc":{"start":{"line":81,"column":68},"end":{"line":81,"column":84}},"line":81},"20":{"name":"(anonymous_20)","decl":{"start":{"line":90,"column":29},"end":{"line":90,"column":30}},"loc":{"start":{"line":90,"column":43},"end":{"line":106,"column":2}},"line":90},"21":{"name":"(anonymous_21)","decl":{"start":{"line":90,"column":77},"end":{"line":90,"column":78}},"loc":{"start":{"line":90,"column":90},"end":{"line":106,"column":1}},"line":90},"22":{"name":"(anonymous_22)","decl":{"start":{"line":108,"column":21},"end":{"line":108,"column":22}},"loc":{"start":{"line":108,"column":35},"end":{"line":132,"column":2}},"line":108},"23":{"name":"(anonymous_23)","decl":{"start":{"line":108,"column":69},"end":{"line":108,"column":70}},"loc":{"start":{"line":108,"column":82},"end":{"line":132,"column":1}},"line":108},"24":{"name":"(anonymous_24)","decl":{"start":{"line":134,"column":19},"end":{"line":134,"column":20}},"loc":{"start":{"line":134,"column":35},"end":{"line":156,"column":2}},"line":134},"25":{"name":"(anonymous_25)","decl":{"start":{"line":134,"column":69},"end":{"line":134,"column":70}},"loc":{"start":{"line":134,"column":82},"end":{"line":156,"column":1}},"line":134},"26":{"name":"(anonymous_26)","decl":{"start":{"line":145,"column":48},"end":{"line":145,"column":49}},"loc":{"start":{"line":145,"column":61},"end":{"line":145,"column":80}},"line":145}},"branchMap":{"0":{"loc":{"start":{"line":2,"column":16},"end":{"line":10,"column":1}},"type":"binary-expr","locations":[{"start":{"line":2,"column":17},"end":{"line":2,"column":21}},{"start":{"line":2,"column":25},"end":{"line":2,"column":39}},{"start":{"line":2,"column":44},"end":{"line":10,"column":1}}],"line":2},"1":{"loc":{"start":{"line":3,"column":35},"end":{"line":3,"column":109}},"type":"cond-expr","locations":[{"start":{"line":3,"column":56},"end":{"line":3,"column":61}},{"start":{"line":3,"column":64},"end":{"line":3,"column":109}}],"line":3},"2":{"loc":{"start":{"line":4,"column":16},"end":{"line":4,"column":34}},"type":"binary-expr","locations":[{"start":{"line":4,"column":16},"end":{"line":4,"column":17}},{"start":{"line":4,"column":22},"end":{"line":4,"column":33}}],"line":4},"3":{"loc":{"start":{"line":7,"column":32},"end":{"line":7,"column":115}},"type":"cond-expr","locations":[{"start":{"line":7,"column":46},"end":{"line":7,"column":67}},{"start":{"line":7,"column":70},"end":{"line":7,"column":115}}],"line":7},"4":{"loc":{"start":{"line":8,"column":51},"end":{"line":8,"column":67}},"type":"binary-expr","locations":[{"start":{"line":8,"column":51},"end":{"line":8,"column":61}},{"start":{"line":8,"column":65},"end":{"line":8,"column":67}}],"line":8},"5":{"loc":{"start":{"line":11,"column":22},"end":{"line":13,"column":1}},"type":"binary-expr","locations":[{"start":{"line":11,"column":23},"end":{"line":11,"column":27}},{"start":{"line":11,"column":31},"end":{"line":11,"column":51}},{"start":{"line":11,"column":56},"end":{"line":13,"column":1}}],"line":11},"6":{"loc":{"start":{"line":12,"column":11},"end":{"line":12,"column":61}},"type":"cond-expr","locations":[{"start":{"line":12,"column":37},"end":{"line":12,"column":40}},{"start":{"line":12,"column":43},"end":{"line":12,"column":61}}],"line":12},"7":{"loc":{"start":{"line":12,"column":12},"end":{"line":12,"column":33}},"type":"binary-expr","locations":[{"start":{"line":12,"column":12},"end":{"line":12,"column":15}},{"start":{"line":12,"column":19},"end":{"line":12,"column":33}}],"line":12},"8":{"loc":{"start":{"line":22,"column":4},"end":{"line":23,"column":15}},"type":"if","locations":[{"start":{"line":22,"column":4},"end":{"line":23,"column":15}},{"start":{"line":22,"column":4},"end":{"line":23,"column":15}}],"line":22},"9":{"loc":{"start":{"line":26,"column":4},"end":{"line":28,"column":5}},"type":"if","locations":[{"start":{"line":26,"column":4},"end":{"line":28,"column":5}},{"start":{"line":26,"column":4},"end":{"line":28,"column":5}}],"line":26},"10":{"loc":{"start":{"line":26,"column":8},"end":{"line":26,"column":77}},"type":"binary-expr","locations":[{"start":{"line":26,"column":8},"end":{"line":26,"column":13}},{"start":{"line":26,"column":18},"end":{"line":26,"column":32}},{"start":{"line":26,"column":36},"end":{"line":26,"column":76}}],"line":26},"11":{"loc":{"start":{"line":30,"column":30},"end":{"line":30,"column":82}},"type":"binary-expr","locations":[{"start":{"line":30,"column":30},"end":{"line":30,"column":43}},{"start":{"line":30,"column":47},"end":{"line":30,"column":66}},{"start":{"line":30,"column":70},"end":{"line":30,"column":82}}],"line":30},"12":{"loc":{"start":{"line":33,"column":24},"end":{"line":33,"column":175}},"type":"binary-expr","locations":[{"start":{"line":33,"column":25},"end":{"line":33,"column":91}},{"start":{"line":33,"column":97},"end":{"line":33,"column":174}}],"line":33},"13":{"loc":{"start":{"line":33,"column":25},"end":{"line":33,"column":91}},"type":"cond-expr","locations":[{"start":{"line":33,"column":76},"end":{"line":33,"column":82}},{"start":{"line":33,"column":85},"end":{"line":33,"column":91}}],"line":33},"14":{"loc":{"start":{"line":33,"column":25},"end":{"line":33,"column":73}},"type":"binary-expr","locations":[{"start":{"line":33,"column":25},"end":{"line":33,"column":56}},{"start":{"line":33,"column":60},"end":{"line":33,"column":73}}],"line":33},"15":{"loc":{"start":{"line":33,"column":97},"end":{"line":33,"column":174}},"type":"cond-expr","locations":[{"start":{"line":33,"column":148},"end":{"line":33,"column":154}},{"start":{"line":33,"column":157},"end":{"line":33,"column":174}}],"line":33},"16":{"loc":{"start":{"line":33,"column":97},"end":{"line":33,"column":145}},"type":"binary-expr","locations":[{"start":{"line":33,"column":97},"end":{"line":33,"column":128}},{"start":{"line":33,"column":132},"end":{"line":33,"column":145}}],"line":33},"17":{"loc":{"start":{"line":38,"column":4},"end":{"line":41,"column":68}},"type":"if","locations":[{"start":{"line":38,"column":4},"end":{"line":41,"column":68}},{"start":{"line":38,"column":4},"end":{"line":41,"column":68}}],"line":38},"18":{"loc":{"start":{"line":46,"column":12},"end":{"line":46,"column":20}},"type":"default-arg","locations":[{"start":{"line":46,"column":19},"end":{"line":46,"column":20}}],"line":46},"19":{"loc":{"start":{"line":46,"column":22},"end":{"line":46,"column":32}},"type":"default-arg","locations":[{"start":{"line":46,"column":30},"end":{"line":46,"column":32}}],"line":46},"20":{"loc":{"start":{"line":46,"column":34},"end":{"line":46,"column":44}},"type":"default-arg","locations":[{"start":{"line":46,"column":42},"end":{"line":46,"column":44}}],"line":46},"21":{"loc":{"start":{"line":46,"column":46},"end":{"line":46,"column":66}},"type":"default-arg","locations":[{"start":{"line":46,"column":53},"end":{"line":46,"column":66}}],"line":46},"22":{"loc":{"start":{"line":48,"column":4},"end":{"line":52,"column":5}},"type":"if","locations":[{"start":{"line":48,"column":4},"end":{"line":52,"column":5}},{"start":{"line":48,"column":4},"end":{"line":52,"column":5}}],"line":48},"23":{"loc":{"start":{"line":48,"column":8},"end":{"line":48,"column":31}},"type":"binary-expr","locations":[{"start":{"line":48,"column":8},"end":{"line":48,"column":14}},{"start":{"line":48,"column":18},"end":{"line":48,"column":31}}],"line":48},"24":{"loc":{"start":{"line":64,"column":4},"end":{"line":65,"column":75}},"type":"if","locations":[{"start":{"line":64,"column":4},"end":{"line":65,"column":75}},{"start":{"line":64,"column":4},"end":{"line":65,"column":75}}],"line":64},"25":{"loc":{"start":{"line":67,"column":4},"end":{"line":68,"column":71}},"type":"if","locations":[{"start":{"line":67,"column":4},"end":{"line":68,"column":71}},{"start":{"line":67,"column":4},"end":{"line":68,"column":71}}],"line":67},"26":{"loc":{"start":{"line":74,"column":20},"end":{"line":74,"column":59}},"type":"binary-expr","locations":[{"start":{"line":74,"column":20},"end":{"line":74,"column":38}},{"start":{"line":74,"column":42},"end":{"line":74,"column":59}}],"line":74},"27":{"loc":{"start":{"line":75,"column":4},"end":{"line":76,"column":81}},"type":"if","locations":[{"start":{"line":75,"column":4},"end":{"line":76,"column":81}},{"start":{"line":75,"column":4},"end":{"line":76,"column":81}}],"line":75},"28":{"loc":{"start":{"line":78,"column":4},"end":{"line":79,"column":71}},"type":"if","locations":[{"start":{"line":78,"column":4},"end":{"line":79,"column":71}},{"start":{"line":78,"column":4},"end":{"line":79,"column":71}}],"line":78},"29":{"loc":{"start":{"line":82,"column":21},"end":{"line":82,"column":108}},"type":"cond-expr","locations":[{"start":{"line":82,"column":76},"end":{"line":82,"column":82}},{"start":{"line":82,"column":85},"end":{"line":82,"column":108}}],"line":82},"30":{"loc":{"start":{"line":82,"column":21},"end":{"line":82,"column":73}},"type":"binary-expr","locations":[{"start":{"line":82,"column":21},"end":{"line":82,"column":44}},{"start":{"line":82,"column":48},"end":{"line":82,"column":73}}],"line":82},"31":{"loc":{"start":{"line":83,"column":4},"end":{"line":86,"column":64}},"type":"if","locations":[{"start":{"line":83,"column":4},"end":{"line":86,"column":64}},{"start":{"line":83,"column":4},"end":{"line":86,"column":64}}],"line":83},"32":{"loc":{"start":{"line":93,"column":4},"end":{"line":94,"column":78}},"type":"if","locations":[{"start":{"line":93,"column":4},"end":{"line":94,"column":78}},{"start":{"line":93,"column":4},"end":{"line":94,"column":78}}],"line":93},"33":{"loc":{"start":{"line":95,"column":20},"end":{"line":95,"column":51}},"type":"binary-expr","locations":[{"start":{"line":95,"column":20},"end":{"line":95,"column":28}},{"start":{"line":95,"column":32},"end":{"line":95,"column":51}}],"line":95},"34":{"loc":{"start":{"line":96,"column":26},"end":{"line":96,"column":65}},"type":"binary-expr","locations":[{"start":{"line":96,"column":26},"end":{"line":96,"column":38}},{"start":{"line":96,"column":42},"end":{"line":96,"column":65}}],"line":96},"35":{"loc":{"start":{"line":97,"column":4},"end":{"line":98,"column":75}},"type":"if","locations":[{"start":{"line":97,"column":4},"end":{"line":98,"column":75}},{"start":{"line":97,"column":4},"end":{"line":98,"column":75}}],"line":97},"36":{"loc":{"start":{"line":101,"column":4},"end":{"line":103,"column":5}},"type":"if","locations":[{"start":{"line":101,"column":4},"end":{"line":103,"column":5}},{"start":{"line":101,"column":4},"end":{"line":103,"column":5}}],"line":101},"37":{"loc":{"start":{"line":101,"column":8},"end":{"line":101,"column":66}},"type":"binary-expr","locations":[{"start":{"line":101,"column":8},"end":{"line":101,"column":22}},{"start":{"line":101,"column":26},"end":{"line":101,"column":66}}],"line":101},"38":{"loc":{"start":{"line":110,"column":4},"end":{"line":111,"column":78}},"type":"if","locations":[{"start":{"line":110,"column":4},"end":{"line":111,"column":78}},{"start":{"line":110,"column":4},"end":{"line":111,"column":78}}],"line":110},"39":{"loc":{"start":{"line":112,"column":20},"end":{"line":112,"column":51}},"type":"binary-expr","locations":[{"start":{"line":112,"column":20},"end":{"line":112,"column":28}},{"start":{"line":112,"column":32},"end":{"line":112,"column":51}}],"line":112},"40":{"loc":{"start":{"line":113,"column":26},"end":{"line":113,"column":65}},"type":"binary-expr","locations":[{"start":{"line":113,"column":26},"end":{"line":113,"column":38}},{"start":{"line":113,"column":42},"end":{"line":113,"column":65}}],"line":113},"41":{"loc":{"start":{"line":115,"column":4},"end":{"line":116,"column":75}},"type":"if","locations":[{"start":{"line":115,"column":4},"end":{"line":116,"column":75}},{"start":{"line":115,"column":4},"end":{"line":116,"column":75}}],"line":115},"42":{"loc":{"start":{"line":118,"column":4},"end":{"line":120,"column":5}},"type":"if","locations":[{"start":{"line":118,"column":4},"end":{"line":120,"column":5}},{"start":{"line":118,"column":4},"end":{"line":120,"column":5}}],"line":118},"43":{"loc":{"start":{"line":118,"column":8},"end":{"line":118,"column":66}},"type":"binary-expr","locations":[{"start":{"line":118,"column":8},"end":{"line":118,"column":22}},{"start":{"line":118,"column":26},"end":{"line":118,"column":66}}],"line":118},"44":{"loc":{"start":{"line":122,"column":8},"end":{"line":125,"column":49}},"type":"if","locations":[{"start":{"line":122,"column":8},"end":{"line":125,"column":49}},{"start":{"line":122,"column":8},"end":{"line":125,"column":49}}],"line":122},"45":{"loc":{"start":{"line":136,"column":4},"end":{"line":139,"column":24}},"type":"if","locations":[{"start":{"line":136,"column":4},"end":{"line":139,"column":24}},{"start":{"line":136,"column":4},"end":{"line":139,"column":24}}],"line":136},"46":{"loc":{"start":{"line":144,"column":4},"end":{"line":154,"column":5}},"type":"if","locations":[{"start":{"line":144,"column":4},"end":{"line":154,"column":5}},{"start":{"line":144,"column":4},"end":{"line":154,"column":5}}],"line":144},"47":{"loc":{"start":{"line":146,"column":8},"end":{"line":153,"column":9}},"type":"if","locations":[{"start":{"line":146,"column":8},"end":{"line":153,"column":9}},{"start":{"line":146,"column":8},"end":{"line":153,"column":9}}],"line":146}},"s":{"0":1,"1":19,"2":9,"3":11,"4":19,"5":19,"6":0,"7":0,"8":0,"9":0,"10":30,"11":11,"12":1,"13":2,"14":1,"15":1,"16":1,"17":1,"18":1,"19":1,"20":1,"21":1,"22":3,"23":3,"24":0,"25":0,"26":0,"27":0,"28":1,"29":5,"30":1,"31":1,"32":1,"33":1,"34":1,"35":1,"36":1,"37":1,"38":0,"39":1,"40":1,"41":1,"42":1,"43":1,"44":1,"45":1,"46":0,"47":0,"48":0,"49":0,"50":1,"51":1,"52":1,"53":1,"54":1,"55":1,"56":1,"57":1,"58":1,"59":0,"60":1,"61":1,"62":0,"63":1,"64":1,"65":1,"66":3,"67":3,"68":3,"69":3,"70":0,"71":3,"72":3,"73":0,"74":3,"75":3,"76":4,"77":3,"78":3,"79":3,"80":0,"81":3,"82":1,"83":1,"84":1,"85":1,"86":1,"87":1,"88":0,"89":1,"90":1,"91":1,"92":0,"93":1,"94":1,"95":1,"96":0,"97":1,"98":1,"99":1,"100":1,"101":1,"102":1,"103":1,"104":0,"105":1,"106":1,"107":1,"108":1,"109":0,"110":1,"111":1,"112":0,"113":1,"114":1,"115":1,"116":0,"117":0,"118":1,"119":1,"120":1,"121":1,"122":3,"123":3,"124":2,"125":1,"126":3,"127":3,"128":3,"129":0,"130":0,"131":0,"132":0,"133":0,"134":3},"f":{"0":11,"1":19,"2":9,"3":11,"4":19,"5":0,"6":30,"7":2,"8":3,"9":5,"10":1,"11":1,"12":1,"13":1,"14":0,"15":1,"16":1,"17":3,"18":3,"19":4,"20":1,"21":1,"22":1,"23":1,"24":3,"25":3,"26":0},"b":{"0":[1,1,1],"1":[10,9],"2":[11,11],"3":[11,19],"4":[11,11],"5":[1,1,1],"6":[1,1],"7":[2,2],"8":[3,0],"9":[0,0],"10":[0,0,0],"11":[5,0,0],"12":[1,0],"13":[0,1],"14":[1,1],"15":[0,0],"16":[0,0],"17":[1,0],"18":[1],"19":[1],"20":[1],"21":[1],"22":[0,1],"23":[1,0],"24":[0,1],"25":[0,1],"26":[3,2],"27":[0,3],"28":[0,3],"29":[1,2],"30":[3,3],"31":[3,0],"32":[0,1],"33":[1,0],"34":[1,0],"35":[0,1],"36":[0,1],"37":[1,0],"38":[0,1],"39":[1,0],"40":[1,0],"41":[0,1],"42":[0,1],"43":[1,0],"44":[1,0],"45":[2,1],"46":[0,3],"47":[0,0]},"inputSourceMap":{"version":3,"file":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/controllers/images.ts","sources":["/mnt/ironwolf2tb/moreillon/dev/node/image_manager/controllers/images.ts"],"names":[],"mappings":"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","sourcesContent":["import Image, { ImageType } from \"../models/image\"\r\nimport createHttpError from \"http-errors\"\r\nimport { parse_form, imageVariants } from \"../utils\"\r\nimport { Request, Response } from \"express\"\r\nimport {\r\n  deleteLocalImage,\r\n  saveImageLocally,\r\n  sendLocalImage,\r\n} from \"../storage/local\"\r\nimport {\r\n  deleteFileFromS3,\r\n  s3Client,\r\n  storeImageToS3,\r\n  streamFileFromS3,\r\n} from \"../storage/s3\"\r\n\r\nconst enforce_restrictions = (image: ImageType, res: Response) => {\r\n  if (!image.restricted) return\r\n  const { user } = res.locals\r\n  const { _id: user_id, isAdmin: user_is_admin } = user\r\n\r\n  if (!user || (!user_is_admin && user_id.toString() !== image.uploader_id)) {\r\n    throw createHttpError(403, `Access to image ${image._id} is restricted`)\r\n  }\r\n}\r\n\r\nconst get_image_id = (req: Request) =>\r\n  req.params.id || req.params.image_id || req.query.id\r\n\r\nexport const upload_image = async (req: Request, res: Response) => {\r\n  const uploader_id = res.locals.user?._id || res.locals.user?.properties._id\r\n\r\n  const {\r\n    fields,\r\n    image: { filepath: uploadTempPath, originalFilename: filename, size },\r\n  }: any = await parse_form(req)\r\n\r\n  const imageProperties = {\r\n    filename,\r\n    size,\r\n    upload_date: new Date(),\r\n    uploader_id,\r\n    ...fields,\r\n  }\r\n\r\n  const record = await Image.create(imageProperties)\r\n\r\n  if (s3Client) await storeImageToS3(uploadTempPath, record)\r\n  else await saveImageLocally(uploadTempPath, record)\r\n\r\n  res.send(record)\r\n}\r\n\r\nexport const get_image_list = async (req: Request, res: Response) => {\r\n  const {\r\n    skip = 0,\r\n    limit = 50,\r\n    order = -1,\r\n    sort = \"upload_date\",\r\n    search,\r\n  }: any = req.query\r\n\r\n  const query: any = {}\r\n\r\n  if (search && search !== \"\") {\r\n    const regex = { $regex: search, $options: \"i\" }\r\n    const searchableProperties = [\"filename\", \"description\"]\r\n    query.$or = searchableProperties.map((p) => ({ [p]: regex }))\r\n  }\r\n\r\n  const items = await Image.find(query)\r\n    .skip(Number(skip))\r\n    .sort({ [sort]: order })\r\n    .limit(Math.max(Number(limit), 0))\r\n\r\n  const total = await Image.countDocuments(query)\r\n\r\n  const response = { total, items }\r\n\r\n  res.send(response)\r\n}\r\n\r\nexport const get_image_details = async (req: Request, res: Response) => {\r\n  const image_id = get_image_id(req)\r\n  if (!image_id) throw createHttpError(400, `ID not present in request`)\r\n\r\n  const image = await Image.findById(image_id)\r\n  if (!image) throw createHttpError(404, `Image not found in DB`)\r\n\r\n  res.send(image)\r\n}\r\n\r\nexport const get_image = async (req: Request, res: Response) => {\r\n  const image_id = get_image_id(req)\r\n  const variant = req.params.variant || req.query.variant\r\n\r\n  if (!image_id) throw createHttpError(400, `Image ID not present in request`)\r\n\r\n  const image = await Image.findById(image_id)\r\n\r\n  if (!image) throw createHttpError(404, `Image not found in DB`)\r\n  enforce_restrictions(image, res)\r\n\r\n  const foundVariation = imageVariants.find(({ name }) => name === variant)\r\n  const filename = foundVariation?.filename\r\n\r\n  if (s3Client) await streamFileFromS3(res, image, filename)\r\n  else await sendLocalImage(res, image, filename)\r\n\r\n  save_views(req, image)\r\n}\r\n\r\nexport const update_image_details = async (req: Request, res: Response) => {\r\n  const { user } = res.locals\r\n  const image_id = req.params.id\r\n  if (!user) throw createHttpError(403, `Unauthorized to delete image`)\r\n\r\n  const user_id = user._id || user.properties._id\r\n  const user_is_admin = user.isAdmin || user.properties.isAdmin\r\n\r\n  if (!image_id) throw createHttpError(400, `ID not present in request`)\r\n\r\n  const new_properties = req.body\r\n\r\n  const image = await Image.findById(image_id)\r\n\r\n  if (!user_is_admin && user_id.toString() !== image.uploader_id) {\r\n    throw createHttpError(403, `Unauthorized to update image`)\r\n  }\r\n\r\n  const updatedImage = await Image.findOneAndUpdate(\r\n    { _id: image_id },\r\n    { $set: { ...new_properties } },\r\n    { new: true }\r\n  )\r\n\r\n  res.send(updatedImage)\r\n}\r\n\r\nexport const delete_image = async (req: Request, res: Response) => {\r\n  const { user } = res.locals\r\n  if (!user) throw createHttpError(403, `Unauthorized to delete image`)\r\n\r\n  const user_id = user._id || user.properties._id\r\n  const user_is_admin = user.isAdmin || user.properties.isAdmin\r\n\r\n  const image_id = get_image_id(req)\r\n  if (!image_id) throw createHttpError(400, `ID not present in request`)\r\n\r\n  const image = await Image.findById(image_id)\r\n\r\n  if (!user_is_admin && user_id.toString() !== image.uploader_id) {\r\n    throw createHttpError(403, `Unauthorized to delete image`)\r\n  }\r\n\r\n  try {\r\n    if (s3Client) deleteFileFromS3(image)\r\n    else deleteLocalImage(image)\r\n  } catch (error) {\r\n    console.log(error)\r\n  }\r\n\r\n  await image.remove()\r\n\r\n  res.send({ image_id })\r\n}\r\n\r\nconst save_views = async (req: Request, image: ImageType) => {\r\n  // Increase view count\r\n  if (image.views) image.views += 1\r\n  else image.views = 1\r\n\r\n  // Save last view data\r\n  image.last_viewed = new Date()\r\n\r\n  // save referer\r\n  const referer_url = req.get(\"Referrer\")\r\n\r\n  if (referer_url) {\r\n    let found_referer = image.referers.find(\r\n      ({ url }: { url: string }) => url === referer_url\r\n    )\r\n\r\n    if (found_referer) found_referer.last_request = new Date()\r\n    else {\r\n      image.referers.push({\r\n        url: referer_url,\r\n        last_request: new Date(),\r\n      })\r\n    }\r\n  }\r\n\r\n  await image.save()\r\n}\r\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"a31601baa3553f73acd3d06e65a7b089af1d2773","contentHash":"ea7b8e71a515ede712e3c426e1bbb24aaa12b127fd0dce648f5efaa16ceccb5a"},"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/models/image.ts":{"path":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/models/image.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":19},"end":{"line":3,"column":38}},"2":{"start":{"line":4,"column":20},"end":{"line":16,"column":2}},"3":{"start":{"line":17,"column":14},"end":{"line":17,"column":57}},"4":{"start":{"line":18,"column":0},"end":{"line":18,"column":24}}},"fnMap":{},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1},"f":{},"b":{},"inputSourceMap":{"version":3,"file":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/models/image.ts","sources":["/mnt/ironwolf2tb/moreillon/dev/node/image_manager/models/image.ts"],"names":[],"mappings":";;AAAA,uCAAwC;AAsBxC,MAAM,WAAW,GAAG,IAAI,iBAAM,CAAY;IACxC,QAAQ,EAAE,MAAM;IAChB,IAAI,EAAE,MAAM;IAEZ,WAAW,EAAE,MAAM;IACnB,IAAI,EAAE,MAAM;IACZ,WAAW,EAAE,IAAI;IACjB,WAAW,EAAE,MAAM;IAEnB,UAAU,EAAE,OAAO;IAEnB,mDAAmD;IACnD,WAAW,EAAE,IAAI;IACjB,KAAK,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,OAAO,EAAE,CAAC,EAAE;IACnC,QAAQ,EAAE,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,EAAE,EAAE;CACvC,CAAC,CAAA;AAEF,MAAM,KAAK,GAAG,IAAA,gBAAK,EAAC,OAAO,EAAE,WAAW,CAAC,CAAA;AAEzC,kBAAe,KAAK,CAAA","sourcesContent":["import { Schema, model } from \"mongoose\"\r\n\r\nexport type ImageType = {\r\n  _id: Schema.Types.ObjectId | string\r\n  filename: string\r\n  path: string // Legacy, renamed into filename above\r\n\r\n  description: string // Optional description\r\n  size: number\r\n  upload_date: Date\r\n  uploader_id: string\r\n\r\n  restricted: Boolean // Whether an image can be viewed by someone else than the uploader\r\n\r\n  // Keeping track of views and origin of those views\r\n  last_viewed: Date\r\n  views: number\r\n  referers: any[]\r\n\r\n  save: Function\r\n}\r\n\r\nconst ImageSchema = new Schema<ImageType>({\r\n  filename: String,\r\n  path: String, // Legacy, renamed into filename above\r\n\r\n  description: String, // Optional description\r\n  size: Number,\r\n  upload_date: Date,\r\n  uploader_id: String,\r\n\r\n  restricted: Boolean, // Whether an image can be viewed by someone else than the uploader\r\n\r\n  // Keeping track of views and origin of those views\r\n  last_viewed: Date,\r\n  views: { type: Number, default: 0 },\r\n  referers: { type: Array, default: [] },\r\n})\r\n\r\nconst Image = model(\"Image\", ImageSchema)\r\n\r\nexport default Image\r\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"e9405567032291e4fcaec31bda4f4b5ded9cfe48","contentHash":"00716b21a47f16e5b81fc92e3eeafb333d2c2968b16d349054d2582edc4a4818"},"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/utils.ts":{"path":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/utils.ts","statementMap":{"0":{"start":{"line":2,"column":16},"end":{"line":10,"column":1}},"1":{"start":{"line":3,"column":28},"end":{"line":3,"column":110}},"2":{"start":{"line":3,"column":91},"end":{"line":3,"column":106}},"3":{"start":{"line":4,"column":4},"end":{"line":9,"column":7}},"4":{"start":{"line":5,"column":36},"end":{"line":5,"column":97}},"5":{"start":{"line":5,"column":42},"end":{"line":5,"column":70}},"6":{"start":{"line":5,"column":85},"end":{"line":5,"column":95}},"7":{"start":{"line":6,"column":35},"end":{"line":6,"column":100}},"8":{"start":{"line":6,"column":41},"end":{"line":6,"column":73}},"9":{"start":{"line":6,"column":88},"end":{"line":6,"column":98}},"10":{"start":{"line":7,"column":32},"end":{"line":7,"column":116}},"11":{"start":{"line":8,"column":8},"end":{"line":8,"column":78}},"12":{"start":{"line":11,"column":22},"end":{"line":13,"column":1}},"13":{"start":{"line":12,"column":4},"end":{"line":12,"column":62}},"14":{"start":{"line":14,"column":0},"end":{"line":14,"column":62}},"15":{"start":{"line":15,"column":0},"end":{"line":15,"column":85}},"16":{"start":{"line":16,"column":16},"end":{"line":16,"column":49}},"17":{"start":{"line":17,"column":15},"end":{"line":17,"column":47}},"18":{"start":{"line":18,"column":21},"end":{"line":18,"column":59}},"19":{"start":{"line":19,"column":22},"end":{"line":19,"column":61}},"20":{"start":{"line":20,"column":19},"end":{"line":34,"column":2}},"21":{"start":{"line":20,"column":28},"end":{"line":34,"column":2}},"22":{"start":{"line":21,"column":4},"end":{"line":33,"column":7}},"23":{"start":{"line":22,"column":21},"end":{"line":22,"column":50}},"24":{"start":{"line":23,"column":8},"end":{"line":32,"column":11}},"25":{"start":{"line":24,"column":12},"end":{"line":25,"column":35}},"26":{"start":{"line":25,"column":16},"end":{"line":25,"column":35}},"27":{"start":{"line":26,"column":28},"end":{"line":26,"column":39}},"28":{"start":{"line":28,"column":36},"end":{"line":28,"column":148}},"29":{"start":{"line":28,"column":78},"end":{"line":28,"column":142}},"30":{"start":{"line":29,"column":12},"end":{"line":30,"column":88}},"31":{"start":{"line":30,"column":16},"end":{"line":30,"column":88}},"32":{"start":{"line":31,"column":12},"end":{"line":31,"column":56}},"33":{"start":{"line":35,"column":0},"end":{"line":35,"column":32}},"34":{"start":{"line":36,"column":31},"end":{"line":39,"column":1}},"35":{"start":{"line":37,"column":21},"end":{"line":37,"column":60}},"36":{"start":{"line":38,"column":4},"end":{"line":38,"column":35}},"37":{"start":{"line":40,"column":0},"end":{"line":40,"column":56}},"38":{"start":{"line":41,"column":21},"end":{"line":41,"column":42}},"39":{"start":{"line":42,"column":0},"end":{"line":53,"column":2}},"40":{"start":{"line":46,"column":29},"end":{"line":46,"column":162}},"41":{"start":{"line":46,"column":78},"end":{"line":46,"column":159}},"42":{"start":{"line":51,"column":29},"end":{"line":51,"column":145}},"43":{"start":{"line":51,"column":78},"end":{"line":51,"column":142}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":2,"column":44},"end":{"line":2,"column":45}},"loc":{"start":{"line":2,"column":89},"end":{"line":10,"column":1}},"line":2},"1":{"name":"adopt","decl":{"start":{"line":3,"column":13},"end":{"line":3,"column":18}},"loc":{"start":{"line":3,"column":26},"end":{"line":3,"column":112}},"line":3},"2":{"name":"(anonymous_2)","decl":{"start":{"line":3,"column":70},"end":{"line":3,"column":71}},"loc":{"start":{"line":3,"column":89},"end":{"line":3,"column":108}},"line":3},"3":{"name":"(anonymous_3)","decl":{"start":{"line":4,"column":36},"end":{"line":4,"column":37}},"loc":{"start":{"line":4,"column":63},"end":{"line":9,"column":5}},"line":4},"4":{"name":"fulfilled","decl":{"start":{"line":5,"column":17},"end":{"line":5,"column":26}},"loc":{"start":{"line":5,"column":34},"end":{"line":5,"column":99}},"line":5},"5":{"name":"rejected","decl":{"start":{"line":6,"column":17},"end":{"line":6,"column":25}},"loc":{"start":{"line":6,"column":33},"end":{"line":6,"column":102}},"line":6},"6":{"name":"step","decl":{"start":{"line":7,"column":17},"end":{"line":7,"column":21}},"loc":{"start":{"line":7,"column":30},"end":{"line":7,"column":118}},"line":7},"7":{"name":"(anonymous_7)","decl":{"start":{"line":11,"column":56},"end":{"line":11,"column":57}},"loc":{"start":{"line":11,"column":71},"end":{"line":13,"column":1}},"line":11},"8":{"name":"(anonymous_8)","decl":{"start":{"line":20,"column":19},"end":{"line":20,"column":20}},"loc":{"start":{"line":20,"column":28},"end":{"line":34,"column":2}},"line":20},"9":{"name":"(anonymous_9)","decl":{"start":{"line":20,"column":62},"end":{"line":20,"column":63}},"loc":{"start":{"line":20,"column":75},"end":{"line":34,"column":1}},"line":20},"10":{"name":"(anonymous_10)","decl":{"start":{"line":21,"column":23},"end":{"line":21,"column":24}},"loc":{"start":{"line":21,"column":44},"end":{"line":33,"column":5}},"line":21},"11":{"name":"(anonymous_11)","decl":{"start":{"line":23,"column":24},"end":{"line":23,"column":25}},"loc":{"start":{"line":23,"column":48},"end":{"line":32,"column":9}},"line":23},"12":{"name":"(anonymous_12)","decl":{"start":{"line":28,"column":63},"end":{"line":28,"column":64}},"loc":{"start":{"line":28,"column":78},"end":{"line":28,"column":142}},"line":28},"13":{"name":"(anonymous_13)","decl":{"start":{"line":36,"column":31},"end":{"line":36,"column":32}},"loc":{"start":{"line":36,"column":54},"end":{"line":39,"column":1}},"line":36},"14":{"name":"(anonymous_14)","decl":{"start":{"line":46,"column":18},"end":{"line":46,"column":19}},"loc":{"start":{"line":46,"column":29},"end":{"line":46,"column":162}},"line":46},"15":{"name":"(anonymous_15)","decl":{"start":{"line":46,"column":63},"end":{"line":46,"column":64}},"loc":{"start":{"line":46,"column":76},"end":{"line":46,"column":161}},"line":46},"16":{"name":"(anonymous_16)","decl":{"start":{"line":51,"column":18},"end":{"line":51,"column":19}},"loc":{"start":{"line":51,"column":29},"end":{"line":51,"column":145}},"line":51},"17":{"name":"(anonymous_17)","decl":{"start":{"line":51,"column":63},"end":{"line":51,"column":64}},"loc":{"start":{"line":51,"column":76},"end":{"line":51,"column":144}},"line":51}},"branchMap":{"0":{"loc":{"start":{"line":2,"column":16},"end":{"line":10,"column":1}},"type":"binary-expr","locations":[{"start":{"line":2,"column":17},"end":{"line":2,"column":21}},{"start":{"line":2,"column":25},"end":{"line":2,"column":39}},{"start":{"line":2,"column":44},"end":{"line":10,"column":1}}],"line":2},"1":{"loc":{"start":{"line":3,"column":35},"end":{"line":3,"column":109}},"type":"cond-expr","locations":[{"start":{"line":3,"column":56},"end":{"line":3,"column":61}},{"start":{"line":3,"column":64},"end":{"line":3,"column":109}}],"line":3},"2":{"loc":{"start":{"line":4,"column":16},"end":{"line":4,"column":34}},"type":"binary-expr","locations":[{"start":{"line":4,"column":16},"end":{"line":4,"column":17}},{"start":{"line":4,"column":22},"end":{"line":4,"column":33}}],"line":4},"3":{"loc":{"start":{"line":7,"column":32},"end":{"line":7,"column":115}},"type":"cond-expr","locations":[{"start":{"line":7,"column":46},"end":{"line":7,"column":67}},{"start":{"line":7,"column":70},"end":{"line":7,"column":115}}],"line":7},"4":{"loc":{"start":{"line":8,"column":51},"end":{"line":8,"column":67}},"type":"binary-expr","locations":[{"start":{"line":8,"column":51},"end":{"line":8,"column":61}},{"start":{"line":8,"column":65},"end":{"line":8,"column":67}}],"line":8},"5":{"loc":{"start":{"line":11,"column":22},"end":{"line":13,"column":1}},"type":"binary-expr","locations":[{"start":{"line":11,"column":23},"end":{"line":11,"column":27}},{"start":{"line":11,"column":31},"end":{"line":11,"column":51}},{"start":{"line":11,"column":56},"end":{"line":13,"column":1}}],"line":11},"6":{"loc":{"start":{"line":12,"column":11},"end":{"line":12,"column":61}},"type":"cond-expr","locations":[{"start":{"line":12,"column":37},"end":{"line":12,"column":40}},{"start":{"line":12,"column":43},"end":{"line":12,"column":61}}],"line":12},"7":{"loc":{"start":{"line":12,"column":12},"end":{"line":12,"column":33}},"type":"binary-expr","locations":[{"start":{"line":12,"column":12},"end":{"line":12,"column":15}},{"start":{"line":12,"column":19},"end":{"line":12,"column":33}}],"line":12},"8":{"loc":{"start":{"line":24,"column":12},"end":{"line":25,"column":35}},"type":"if","locations":[{"start":{"line":24,"column":12},"end":{"line":25,"column":35}},{"start":{"line":24,"column":12},"end":{"line":25,"column":35}}],"line":24},"9":{"loc":{"start":{"line":29,"column":12},"end":{"line":30,"column":88}},"type":"if","locations":[{"start":{"line":29,"column":12},"end":{"line":30,"column":88}},{"start":{"line":29,"column":12},"end":{"line":30,"column":88}}],"line":29}},"s":{"0":1,"1":0,"2":0,"3":3,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":3,"11":3,"12":1,"13":4,"14":1,"15":1,"16":1,"17":1,"18":1,"19":1,"20":1,"21":1,"22":1,"23":1,"24":1,"25":1,"26":0,"27":1,"28":1,"29":1,"30":1,"31":0,"32":1,"33":1,"34":1,"35":0,"36":0,"37":1,"38":1,"39":1,"40":1,"41":1,"42":1,"43":1},"f":{"0":3,"1":0,"2":0,"3":3,"4":0,"5":0,"6":3,"7":4,"8":1,"9":1,"10":1,"11":1,"12":1,"13":0,"14":1,"15":1,"16":1,"17":1},"b":{"0":[1,1,1],"1":[0,0],"2":[3,3],"3":[3,0],"4":[3,3],"5":[1,1,1],"6":[1,3],"7":[4,4],"8":[0,1],"9":[0,1]},"inputSourceMap":{"version":3,"file":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/utils.ts","sources":["/mnt/ironwolf2tb/moreillon/dev/node/image_manager/utils.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,kDAAyB;AACzB,gDAAuB;AACvB,4DAAmC;AACnC,8DAAyC;AAGlC,MAAM,UAAU,GAAG,CAAO,GAAY,EAAE,EAAE;IAC/C,OAAA,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;QAC9B,MAAM,IAAI,GAAG,IAAA,oBAAU,EAAC,EAAE,CAAC,CAAA;QAE3B,IAAI,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC,GAAG,EAAE,MAAM,EAAE,KAAK,EAAE,EAAE;YACrC,IAAI,GAAG;gBAAE,OAAO,MAAM,CAAC,GAAG,CAAC,CAAA;YAE3B,MAAM,CAAC,KAAK,CAAC,GAAQ,KAAK,CAAC,KAAK,CAAA;YAEhC,0DAA0D;YAC1D,MAAM,eAAe,GAAG,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,MAAM,CAChD,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE,CAAC,iCAAM,GAAG,KAAE,CAAC,GAAG,CAAC,EAAE,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,IAAG,EACjD,EAAE,CACH,CAAA;YAED,IAAI,CAAC,KAAK;gBAAE,MAAM,CAAC,IAAA,qBAAe,EAAC,GAAG,EAAE,8BAA8B,CAAC,CAAC,CAAA;YAExE,OAAO,CAAC,EAAE,KAAK,EAAE,MAAM,EAAE,eAAe,EAAE,CAAC,CAAA;QAC7C,CAAC,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;EAAA,CAAA;AAnBS,QAAA,UAAU,cAmBnB;AAEG,MAAM,sBAAsB,GAAG,CAAC,iBAAyB,EAAE,EAAE;IAClE,MAAM,EAAE,IAAI,EAAE,GAAG,cAAI,CAAC,KAAK,CAAC,iBAAiB,CAAC,CAAA;IAC9C,OAAO,GAAG,IAAI,gBAAgB,CAAA;AAChC,CAAC,CAAA;AAHY,QAAA,sBAAsB,0BAGlC;AAED,MAAM,YAAY,GAAG,EAAE,WAAW,EAAE,IAAI,EAAE,CAAA;AAC7B,QAAA,aAAa,GAAG;IAC3B;QACE,IAAI,EAAE,WAAW;QACjB,QAAQ,EAAE,eAAe;QACzB,QAAQ,EAAE,CAAO,KAAmC,EAAE,EAAE,kDACtD,OAAA,IAAA,eAAK,EAAC,KAAK,EAAE,YAAY,CAAC,CAAC,MAAM,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,YAAY,EAAE,CAAA,GAAA;KAC7D;IACD;QACE,IAAI,EAAE,MAAM;QACZ,QAAQ,EAAE,YAAY;QACtB,QAAQ,EAAE,CAAO,KAAmC,EAAE,EAAE,kDACtD,OAAA,IAAA,eAAK,EAAC,KAAK,EAAE,YAAY,CAAC,CAAC,YAAY,EAAE,CAAA,GAAA;KAC5C;CACF,CAAA","sourcesContent":["import sharp from \"sharp\"\r\nimport path from \"path\"\r\nimport formidable from \"formidable\"\r\nimport createHttpError from \"http-errors\"\r\nimport { Request } from \"express\"\r\n\r\nexport const parse_form = async (req: Request) =>\r\n  new Promise((resolve, reject) => {\r\n    const form = formidable({})\r\n\r\n    form.parse(req, (err, fields, files) => {\r\n      if (err) return reject(err)\r\n\r\n      const [image]: any = files.image\r\n\r\n      // Weird formatting needed to accomodate for formidable v3\r\n      const fieldsFormatted = Object.keys(fields).reduce(\r\n        (acc, key) => ({ ...acc, [key]: fields[key][0] }),\r\n        {}\r\n      )\r\n\r\n      if (!image) reject(createHttpError(400, `Image not present in request`))\r\n\r\n      resolve({ image, fields: fieldsFormatted })\r\n    })\r\n  })\r\n\r\nexport const get_thumbnail_filename = (original_filename: string) => {\r\n  const { name } = path.parse(original_filename)\r\n  return `${name}_thumbnail.jpg`\r\n}\r\n\r\nconst sharpOptions = { failOnError: true }\r\nexport const imageVariants = [\r\n  {\r\n    name: \"thumbnail\",\r\n    filename: \"thumbnail.jpg\",\r\n    generate: async (input: string | Buffer | Uint8Array) =>\r\n      sharp(input, sharpOptions).resize(256, 256).withMetadata(),\r\n  },\r\n  {\r\n    name: \"webp\",\r\n    filename: \"image.webp\",\r\n    generate: async (input: string | Buffer | Uint8Array) =>\r\n      sharp(input, sharpOptions).withMetadata(),\r\n  },\r\n]\r\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"c540e7ac5b0d9fb84ad67ae993845a54bd026917","contentHash":"80c76e0dd9acf9f2b5823c4653f2deb5ac267598d5687fced5223b35a5f75596"},"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/storage/local.ts":{"path":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/storage/local.ts","statementMap":{"0":{"start":{"line":2,"column":16},"end":{"line":10,"column":1}},"1":{"start":{"line":3,"column":28},"end":{"line":3,"column":110}},"2":{"start":{"line":3,"column":91},"end":{"line":3,"column":106}},"3":{"start":{"line":4,"column":4},"end":{"line":9,"column":7}},"4":{"start":{"line":5,"column":36},"end":{"line":5,"column":97}},"5":{"start":{"line":5,"column":42},"end":{"line":5,"column":70}},"6":{"start":{"line":5,"column":85},"end":{"line":5,"column":95}},"7":{"start":{"line":6,"column":35},"end":{"line":6,"column":100}},"8":{"start":{"line":6,"column":41},"end":{"line":6,"column":73}},"9":{"start":{"line":6,"column":88},"end":{"line":6,"column":98}},"10":{"start":{"line":7,"column":32},"end":{"line":7,"column":116}},"11":{"start":{"line":8,"column":8},"end":{"line":8,"column":78}},"12":{"start":{"line":11,"column":20},"end":{"line":17,"column":1}},"13":{"start":{"line":12,"column":4},"end":{"line":12,"column":91}},"14":{"start":{"line":12,"column":31},"end":{"line":12,"column":91}},"15":{"start":{"line":13,"column":12},"end":{"line":13,"column":35}},"16":{"start":{"line":14,"column":4},"end":{"line":14,"column":213}},"17":{"start":{"line":14,"column":194},"end":{"line":14,"column":206}},"18":{"start":{"line":15,"column":23},"end":{"line":15,"column":162}},"19":{"start":{"line":15,"column":53},"end":{"line":15,"column":159}},"20":{"start":{"line":15,"column":101},"end":{"line":15,"column":155}},"21":{"start":{"line":16,"column":45},"end":{"line":16,"column":126}},"22":{"start":{"line":16,"column":83},"end":{"line":16,"column":114}},"23":{"start":{"line":18,"column":22},"end":{"line":20,"column":1}},"24":{"start":{"line":19,"column":4},"end":{"line":19,"column":62}},"25":{"start":{"line":22,"column":0},"end":{"line":22,"column":62}},"26":{"start":{"line":23,"column":0},"end":{"line":23,"column":114}},"27":{"start":{"line":24,"column":15},"end":{"line":24,"column":47}},"28":{"start":{"line":25,"column":17},"end":{"line":25,"column":34}},"29":{"start":{"line":26,"column":16},"end":{"line":26,"column":35}},"30":{"start":{"line":27,"column":13},"end":{"line":27,"column":26}},"31":{"start":{"line":28,"column":13},"end":{"line":28,"column":43}},"32":{"start":{"line":29,"column":0},"end":{"line":29,"column":101}},"33":{"start":{"line":30,"column":18},"end":{"line":36,"column":2}},"34":{"start":{"line":30,"column":55},"end":{"line":36,"column":2}},"35":{"start":{"line":31,"column":4},"end":{"line":35,"column":7}},"36":{"start":{"line":32,"column":8},"end":{"line":33,"column":24}},"37":{"start":{"line":33,"column":12},"end":{"line":33,"column":24}},"38":{"start":{"line":34,"column":8},"end":{"line":34,"column":22}},"39":{"start":{"line":37,"column":25},"end":{"line":59,"column":2}},"40":{"start":{"line":37,"column":37},"end":{"line":59,"column":2}},"41":{"start":{"line":39,"column":30},"end":{"line":39,"column":36}},"42":{"start":{"line":40,"column":30},"end":{"line":40,"column":92}},"43":{"start":{"line":41,"column":32},"end":{"line":41,"column":80}},"44":{"start":{"line":42,"column":4},"end":{"line":58,"column":5}},"45":{"start":{"line":43,"column":8},"end":{"line":50,"column":9}},"46":{"start":{"line":43,"column":22},"end":{"line":43,"column":26}},"47":{"start":{"line":43,"column":33},"end":{"line":43,"column":97}},"48":{"start":{"line":43,"column":83},"end":{"line":43,"column":95}},"49":{"start":{"line":44,"column":12},"end":{"line":44,"column":26}},"50":{"start":{"line":45,"column":12},"end":{"line":45,"column":23}},"51":{"start":{"line":46,"column":28},"end":{"line":46,"column":30}},"52":{"start":{"line":47,"column":32},"end":{"line":47,"column":75}},"53":{"start":{"line":48,"column":32},"end":{"line":48,"column":91}},"54":{"start":{"line":49,"column":12},"end":{"line":49,"column":50}},"55":{"start":{"line":52,"column":20},"end":{"line":52,"column":43}},"56":{"start":{"line":54,"column":8},"end":{"line":57,"column":45}},"57":{"start":{"line":55,"column":12},"end":{"line":55,"column":66}},"58":{"start":{"line":55,"column":48},"end":{"line":55,"column":66}},"59":{"start":{"line":57,"column":18},"end":{"line":57,"column":43}},"60":{"start":{"line":57,"column":27},"end":{"line":57,"column":43}},"61":{"start":{"line":60,"column":25},"end":{"line":66,"column":2}},"62":{"start":{"line":60,"column":53},"end":{"line":66,"column":2}},"63":{"start":{"line":61,"column":30},"end":{"line":61,"column":36}},"64":{"start":{"line":62,"column":30},"end":{"line":62,"column":92}},"65":{"start":{"line":63,"column":32},"end":{"line":63,"column":80}},"66":{"start":{"line":64,"column":4},"end":{"line":64,"column":57}},"67":{"start":{"line":65,"column":4},"end":{"line":65,"column":35}},"68":{"start":{"line":67,"column":0},"end":{"line":67,"column":44}},"69":{"start":{"line":69,"column":23},"end":{"line":76,"column":2}},"70":{"start":{"line":69,"column":49},"end":{"line":76,"column":2}},"71":{"start":{"line":70,"column":21},"end":{"line":70,"column":117}},"72":{"start":{"line":71,"column":4},"end":{"line":74,"column":5}},"73":{"start":{"line":72,"column":8},"end":{"line":72,"column":108}},"74":{"start":{"line":73,"column":8},"end":{"line":73,"column":38}},"75":{"start":{"line":75,"column":4},"end":{"line":75,"column":27}},"76":{"start":{"line":77,"column":0},"end":{"line":77,"column":40}},"77":{"start":{"line":78,"column":25},"end":{"line":81,"column":2}},"78":{"start":{"line":78,"column":37},"end":{"line":81,"column":2}},"79":{"start":{"line":79,"column":30},"end":{"line":79,"column":99}},"80":{"start":{"line":80,"column":4},"end":{"line":80,"column":48}},"81":{"start":{"line":82,"column":0},"end":{"line":82,"column":44}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":2,"column":44},"end":{"line":2,"column":45}},"loc":{"start":{"line":2,"column":89},"end":{"line":10,"column":1}},"line":2},"1":{"name":"adopt","decl":{"start":{"line":3,"column":13},"end":{"line":3,"column":18}},"loc":{"start":{"line":3,"column":26},"end":{"line":3,"column":112}},"line":3},"2":{"name":"(anonymous_2)","decl":{"start":{"line":3,"column":70},"end":{"line":3,"column":71}},"loc":{"start":{"line":3,"column":89},"end":{"line":3,"column":108}},"line":3},"3":{"name":"(anonymous_3)","decl":{"start":{"line":4,"column":36},"end":{"line":4,"column":37}},"loc":{"start":{"line":4,"column":63},"end":{"line":9,"column":5}},"line":4},"4":{"name":"fulfilled","decl":{"start":{"line":5,"column":17},"end":{"line":5,"column":26}},"loc":{"start":{"line":5,"column":34},"end":{"line":5,"column":99}},"line":5},"5":{"name":"rejected","decl":{"start":{"line":6,"column":17},"end":{"line":6,"column":25}},"loc":{"start":{"line":6,"column":33},"end":{"line":6,"column":102}},"line":6},"6":{"name":"step","decl":{"start":{"line":7,"column":17},"end":{"line":7,"column":21}},"loc":{"start":{"line":7,"column":30},"end":{"line":7,"column":118}},"line":7},"7":{"name":"(anonymous_7)","decl":{"start":{"line":11,"column":52},"end":{"line":11,"column":53}},"loc":{"start":{"line":11,"column":65},"end":{"line":17,"column":1}},"line":11},"8":{"name":"(anonymous_8)","decl":{"start":{"line":14,"column":180},"end":{"line":14,"column":181}},"loc":{"start":{"line":14,"column":192},"end":{"line":14,"column":208}},"line":14},"9":{"name":"verb","decl":{"start":{"line":15,"column":13},"end":{"line":15,"column":17}},"loc":{"start":{"line":15,"column":21},"end":{"line":15,"column":164}},"line":15},"10":{"name":"(anonymous_10)","decl":{"start":{"line":15,"column":38},"end":{"line":15,"column":39}},"loc":{"start":{"line":15,"column":51},"end":{"line":15,"column":161}},"line":15},"11":{"name":"(anonymous_11)","decl":{"start":{"line":15,"column":72},"end":{"line":15,"column":73}},"loc":{"start":{"line":15,"column":99},"end":{"line":15,"column":157}},"line":15},"12":{"name":"settle","decl":{"start":{"line":16,"column":13},"end":{"line":16,"column":19}},"loc":{"start":{"line":16,"column":43},"end":{"line":16,"column":128}},"line":16},"13":{"name":"(anonymous_13)","decl":{"start":{"line":16,"column":69},"end":{"line":16,"column":70}},"loc":{"start":{"line":16,"column":81},"end":{"line":16,"column":116}},"line":16},"14":{"name":"(anonymous_14)","decl":{"start":{"line":18,"column":56},"end":{"line":18,"column":57}},"loc":{"start":{"line":18,"column":71},"end":{"line":20,"column":1}},"line":18},"15":{"name":"(anonymous_15)","decl":{"start":{"line":30,"column":18},"end":{"line":30,"column":19}},"loc":{"start":{"line":30,"column":55},"end":{"line":36,"column":2}},"line":30},"16":{"name":"(anonymous_16)","decl":{"start":{"line":30,"column":67},"end":{"line":30,"column":68}},"loc":{"start":{"line":30,"column":88},"end":{"line":36,"column":1}},"line":30},"17":{"name":"(anonymous_17)","decl":{"start":{"line":31,"column":73},"end":{"line":31,"column":74}},"loc":{"start":{"line":31,"column":82},"end":{"line":35,"column":5}},"line":31},"18":{"name":"(anonymous_18)","decl":{"start":{"line":37,"column":25},"end":{"line":37,"column":26}},"loc":{"start":{"line":37,"column":37},"end":{"line":59,"column":2}},"line":37},"19":{"name":"(anonymous_19)","decl":{"start":{"line":37,"column":71},"end":{"line":37,"column":72}},"loc":{"start":{"line":37,"column":84},"end":{"line":59,"column":1}},"line":37},"20":{"name":"(anonymous_20)","decl":{"start":{"line":43,"column":76},"end":{"line":43,"column":77}},"loc":{"start":{"line":43,"column":83},"end":{"line":43,"column":95}},"line":43},"21":{"name":"(anonymous_21)","decl":{"start":{"line":60,"column":25},"end":{"line":60,"column":26}},"loc":{"start":{"line":60,"column":53},"end":{"line":66,"column":2}},"line":60},"22":{"name":"(anonymous_22)","decl":{"start":{"line":60,"column":87},"end":{"line":60,"column":88}},"loc":{"start":{"line":60,"column":100},"end":{"line":66,"column":1}},"line":60},"23":{"name":"(anonymous_23)","decl":{"start":{"line":69,"column":23},"end":{"line":69,"column":24}},"loc":{"start":{"line":69,"column":49},"end":{"line":76,"column":2}},"line":69},"24":{"name":"(anonymous_24)","decl":{"start":{"line":69,"column":83},"end":{"line":69,"column":84}},"loc":{"start":{"line":69,"column":96},"end":{"line":76,"column":1}},"line":69},"25":{"name":"(anonymous_25)","decl":{"start":{"line":78,"column":25},"end":{"line":78,"column":26}},"loc":{"start":{"line":78,"column":37},"end":{"line":81,"column":2}},"line":78},"26":{"name":"(anonymous_26)","decl":{"start":{"line":78,"column":71},"end":{"line":78,"column":72}},"loc":{"start":{"line":78,"column":84},"end":{"line":81,"column":1}},"line":78}},"branchMap":{"0":{"loc":{"start":{"line":2,"column":16},"end":{"line":10,"column":1}},"type":"binary-expr","locations":[{"start":{"line":2,"column":17},"end":{"line":2,"column":21}},{"start":{"line":2,"column":25},"end":{"line":2,"column":39}},{"start":{"line":2,"column":44},"end":{"line":10,"column":1}}],"line":2},"1":{"loc":{"start":{"line":3,"column":35},"end":{"line":3,"column":109}},"type":"cond-expr","locations":[{"start":{"line":3,"column":56},"end":{"line":3,"column":61}},{"start":{"line":3,"column":64},"end":{"line":3,"column":109}}],"line":3},"2":{"loc":{"start":{"line":4,"column":16},"end":{"line":4,"column":34}},"type":"binary-expr","locations":[{"start":{"line":4,"column":16},"end":{"line":4,"column":17}},{"start":{"line":4,"column":22},"end":{"line":4,"column":33}}],"line":4},"3":{"loc":{"start":{"line":7,"column":32},"end":{"line":7,"column":115}},"type":"cond-expr","locations":[{"start":{"line":7,"column":46},"end":{"line":7,"column":67}},{"start":{"line":7,"column":70},"end":{"line":7,"column":115}}],"line":7},"4":{"loc":{"start":{"line":8,"column":51},"end":{"line":8,"column":67}},"type":"binary-expr","locations":[{"start":{"line":8,"column":51},"end":{"line":8,"column":61}},{"start":{"line":8,"column":65},"end":{"line":8,"column":67}}],"line":8},"5":{"loc":{"start":{"line":11,"column":20},"end":{"line":17,"column":1}},"type":"binary-expr","locations":[{"start":{"line":11,"column":21},"end":{"line":11,"column":25}},{"start":{"line":11,"column":29},"end":{"line":11,"column":47}},{"start":{"line":11,"column":52},"end":{"line":17,"column":1}}],"line":11},"6":{"loc":{"start":{"line":12,"column":4},"end":{"line":12,"column":91}},"type":"if","locations":[{"start":{"line":12,"column":4},"end":{"line":12,"column":91}},{"start":{"line":12,"column":4},"end":{"line":12,"column":91}}],"line":12},"7":{"loc":{"start":{"line":14,"column":11},"end":{"line":14,"column":212}},"type":"cond-expr","locations":[{"start":{"line":14,"column":15},"end":{"line":14,"column":24}},{"start":{"line":14,"column":28},"end":{"line":14,"column":211}}],"line":14},"8":{"loc":{"start":{"line":14,"column":32},"end":{"line":14,"column":99}},"type":"cond-expr","locations":[{"start":{"line":14,"column":65},"end":{"line":14,"column":76}},{"start":{"line":14,"column":79},"end":{"line":14,"column":99}}],"line":14},"9":{"loc":{"start":{"line":15,"column":30},"end":{"line":15,"column":161}},"type":"binary-expr","locations":[{"start":{"line":15,"column":30},"end":{"line":15,"column":34}},{"start":{"line":15,"column":38},"end":{"line":15,"column":161}}],"line":15},"10":{"loc":{"start":{"line":18,"column":22},"end":{"line":20,"column":1}},"type":"binary-expr","locations":[{"start":{"line":18,"column":23},"end":{"line":18,"column":27}},{"start":{"line":18,"column":31},"end":{"line":18,"column":51}},{"start":{"line":18,"column":56},"end":{"line":20,"column":1}}],"line":18},"11":{"loc":{"start":{"line":19,"column":11},"end":{"line":19,"column":61}},"type":"cond-expr","locations":[{"start":{"line":19,"column":37},"end":{"line":19,"column":40}},{"start":{"line":19,"column":43},"end":{"line":19,"column":61}}],"line":19},"12":{"loc":{"start":{"line":19,"column":12},"end":{"line":19,"column":33}},"type":"binary-expr","locations":[{"start":{"line":19,"column":12},"end":{"line":19,"column":15}},{"start":{"line":19,"column":19},"end":{"line":19,"column":33}}],"line":19},"13":{"loc":{"start":{"line":29,"column":64},"end":{"line":29,"column":100}},"type":"cond-expr","locations":[{"start":{"line":29,"column":80},"end":{"line":29,"column":95}},{"start":{"line":29,"column":98},"end":{"line":29,"column":100}}],"line":29},"14":{"loc":{"start":{"line":32,"column":8},"end":{"line":33,"column":24}},"type":"if","locations":[{"start":{"line":32,"column":8},"end":{"line":33,"column":24}},{"start":{"line":32,"column":8},"end":{"line":33,"column":24}}],"line":32},"15":{"loc":{"start":{"line":55,"column":12},"end":{"line":55,"column":66}},"type":"if","locations":[{"start":{"line":55,"column":12},"end":{"line":55,"column":66}},{"start":{"line":55,"column":12},"end":{"line":55,"column":66}}],"line":55},"16":{"loc":{"start":{"line":55,"column":16},"end":{"line":55,"column":46}},"type":"binary-expr","locations":[{"start":{"line":55,"column":16},"end":{"line":55,"column":19}},{"start":{"line":55,"column":23},"end":{"line":55,"column":26}},{"start":{"line":55,"column":31},"end":{"line":55,"column":45}}],"line":55},"17":{"loc":{"start":{"line":57,"column":18},"end":{"line":57,"column":43}},"type":"if","locations":[{"start":{"line":57,"column":18},"end":{"line":57,"column":43}},{"start":{"line":57,"column":18},"end":{"line":57,"column":43}}],"line":57},"18":{"loc":{"start":{"line":70,"column":90},"end":{"line":70,"column":116}},"type":"binary-expr","locations":[{"start":{"line":70,"column":90},"end":{"line":70,"column":98}},{"start":{"line":70,"column":102},"end":{"line":70,"column":116}}],"line":70},"19":{"loc":{"start":{"line":71,"column":4},"end":{"line":74,"column":5}},"type":"if","locations":[{"start":{"line":71,"column":4},"end":{"line":74,"column":5}},{"start":{"line":71,"column":4},"end":{"line":74,"column":5}}],"line":71}},"s":{"0":1,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":1,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":1,"24":2,"25":1,"26":1,"27":1,"28":1,"29":1,"30":1,"31":1,"32":1,"33":1,"34":0,"35":0,"36":0,"37":0,"38":0,"39":1,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0,"50":0,"51":0,"52":0,"53":0,"54":0,"55":0,"56":0,"57":0,"58":0,"59":0,"60":0,"61":1,"62":0,"63":0,"64":0,"65":0,"66":0,"67":0,"68":1,"69":1,"70":0,"71":0,"72":0,"73":0,"74":0,"75":0,"76":1,"77":1,"78":0,"79":0,"80":0,"81":1},"f":{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":2,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0},"b":{"0":[1,1,1],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[1,1,1],"6":[0,0],"7":[0,0],"8":[0,0],"9":[0,0],"10":[1,1,1],"11":[0,2],"12":[2,2],"13":[0,1],"14":[0,0],"15":[0,0],"16":[0,0,0],"17":[0,0],"18":[0,0],"19":[0,0]},"inputSourceMap":{"version":3,"file":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/storage/local.ts","sources":["/mnt/ironwolf2tb/moreillon/dev/node/image_manager/storage/local.ts"],"names":[],"mappings":"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","sourcesContent":["import path from \"path\"\nimport { Response } from \"express\"\nimport { rimrafSync } from \"rimraf\"\nimport { ImageType } from \"../models/image\"\nimport { imageVariants } from \"../utils\"\nimport { existsSync } from \"fs\"\nimport mv from \"mv\"\n\nexport const { UPLOADS_DIRECTORY = \"/usr/share/pv\" } = process.env\n\nconst move_file = (original_path: string, destination_path: string) =>\n  new Promise((resolve, reject) => {\n    mv(original_path, destination_path, { mkdirp: true }, (err) => {\n      if (err) reject(err)\n      resolve(null)\n    })\n  })\n\nconst generateVariants = async (record: ImageType) => {\n  const { _id, filename } = record\n  const destinationFolder = path.join(UPLOADS_DIRECTORY, _id.toString())\n  const destinationFilePath = path.join(destinationFolder, filename)\n  for await (const variant of imageVariants.filter((v) => !!v.generate)) {\n    const variantData = await variant.generate(destinationFilePath)\n    const variantPath = path.resolve(destinationFolder, variant.filename)\n    await variantData.toFile(variantPath)\n  }\n}\n\nexport const saveImageLocally = async (\n  tempUploadPath: string,\n  record: ImageType\n) => {\n  const { _id, filename } = record\n\n  const destinationFolder = path.join(UPLOADS_DIRECTORY, _id.toString())\n\n  const destinationFilePath = path.join(destinationFolder, filename)\n  await move_file(tempUploadPath, destinationFilePath)\n  await generateVariants(record)\n}\n\n// TODO: consider using variant instead of filename\nexport const sendLocalImage = async (\n  res: Response,\n  image: any,\n  filename?: string\n) => {\n  const filePath = path.join(\n    UPLOADS_DIRECTORY,\n    image._id.toString(),\n    filename || image.filename\n  )\n\n  if (!existsSync(filePath)) {\n    console.log(\n      `One or more variant missing for image ${image._id.toString()}, regenerating files...`\n    )\n    await generateVariants(image)\n  }\n\n  res.sendFile(filePath)\n}\n\nexport const deleteLocalImage = async (record: ImageType) => {\n  const image_folder_path = path.join(UPLOADS_DIRECTORY, record._id.toString())\n  rimrafSync(image_folder_path)\n}\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"6b5b67a5f6cc41975e785bf18bb31dff36c526d1","contentHash":"3be648b4d51f361bd56d7901d2772ea7c24a4c3831d33b26f0d9ef2abedd6cae"},"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/storage/s3.ts":{"path":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/storage/s3.ts","statementMap":{"0":{"start":{"line":2,"column":16},"end":{"line":10,"column":1}},"1":{"start":{"line":3,"column":28},"end":{"line":3,"column":110}},"2":{"start":{"line":3,"column":91},"end":{"line":3,"column":106}},"3":{"start":{"line":4,"column":4},"end":{"line":9,"column":7}},"4":{"start":{"line":5,"column":36},"end":{"line":5,"column":97}},"5":{"start":{"line":5,"column":42},"end":{"line":5,"column":70}},"6":{"start":{"line":5,"column":85},"end":{"line":5,"column":95}},"7":{"start":{"line":6,"column":35},"end":{"line":6,"column":100}},"8":{"start":{"line":6,"column":41},"end":{"line":6,"column":73}},"9":{"start":{"line":6,"column":88},"end":{"line":6,"column":98}},"10":{"start":{"line":7,"column":32},"end":{"line":7,"column":116}},"11":{"start":{"line":8,"column":8},"end":{"line":8,"column":78}},"12":{"start":{"line":11,"column":20},"end":{"line":17,"column":1}},"13":{"start":{"line":12,"column":4},"end":{"line":12,"column":91}},"14":{"start":{"line":12,"column":31},"end":{"line":12,"column":91}},"15":{"start":{"line":13,"column":12},"end":{"line":13,"column":35}},"16":{"start":{"line":14,"column":4},"end":{"line":14,"column":213}},"17":{"start":{"line":14,"column":194},"end":{"line":14,"column":206}},"18":{"start":{"line":15,"column":23},"end":{"line":15,"column":162}},"19":{"start":{"line":15,"column":53},"end":{"line":15,"column":159}},"20":{"start":{"line":15,"column":101},"end":{"line":15,"column":155}},"21":{"start":{"line":16,"column":45},"end":{"line":16,"column":126}},"22":{"start":{"line":16,"column":83},"end":{"line":16,"column":114}},"23":{"start":{"line":18,"column":22},"end":{"line":20,"column":1}},"24":{"start":{"line":19,"column":4},"end":{"line":19,"column":62}},"25":{"start":{"line":22,"column":0},"end":{"line":22,"column":62}},"26":{"start":{"line":23,"column":0},"end":{"line":23,"column":225}},"27":{"start":{"line":24,"column":20},"end":{"line":24,"column":49}},"28":{"start":{"line":25,"column":15},"end":{"line":25,"column":47}},"29":{"start":{"line":26,"column":13},"end":{"line":26,"column":26}},"30":{"start":{"line":27,"column":16},"end":{"line":27,"column":35}},"31":{"start":{"line":28,"column":0},"end":{"line":28,"column":287}},"32":{"start":{"line":29,"column":0},"end":{"line":42,"column":1}},"33":{"start":{"line":30,"column":4},"end":{"line":30,"column":83}},"34":{"start":{"line":31,"column":4},"end":{"line":38,"column":7}},"35":{"start":{"line":41,"column":4},"end":{"line":41,"column":75}},"36":{"start":{"line":43,"column":25},"end":{"line":77,"column":2}},"37":{"start":{"line":43,"column":37},"end":{"line":77,"column":2}},"38":{"start":{"line":46,"column":4},"end":{"line":47,"column":34}},"39":{"start":{"line":47,"column":8},"end":{"line":47,"column":34}},"40":{"start":{"line":48,"column":20},"end":{"line":51,"column":5}},"41":{"start":{"line":52,"column":21},"end":{"line":52,"column":91}},"42":{"start":{"line":53,"column":16},"end":{"line":53,"column":107}},"43":{"start":{"line":54,"column":4},"end":{"line":55,"column":37}},"44":{"start":{"line":55,"column":8},"end":{"line":55,"column":37}},"45":{"start":{"line":56,"column":4},"end":{"line":76,"column":5}},"46":{"start":{"line":57,"column":8},"end":{"line":68,"column":9}},"47":{"start":{"line":57,"column":22},"end":{"line":57,"column":26}},"48":{"start":{"line":57,"column":46},"end":{"line":57,"column":82}},"49":{"start":{"line":58,"column":12},"end":{"line":58,"column":41}},"50":{"start":{"line":59,"column":12},"end":{"line":59,"column":23}},"51":{"start":{"line":60,"column":28},"end":{"line":60,"column":30}},"52":{"start":{"line":61,"column":32},"end":{"line":61,"column":59}},"53":{"start":{"line":62,"column":25},"end":{"line":62,"column":53}},"54":{"start":{"line":63,"column":12},"end":{"line":67,"column":16}},"55":{"start":{"line":70,"column":20},"end":{"line":70,"column":43}},"56":{"start":{"line":72,"column":8},"end":{"line":75,"column":45}},"57":{"start":{"line":73,"column":12},"end":{"line":73,"column":92}},"58":{"start":{"line":73,"column":61},"end":{"line":73,"column":92}},"59":{"start":{"line":75,"column":18},"end":{"line":75,"column":43}},"60":{"start":{"line":75,"column":27},"end":{"line":75,"column":43}},"61":{"start":{"line":78,"column":23},"end":{"line":89,"column":2}},"62":{"start":{"line":78,"column":51},"end":{"line":89,"column":2}},"63":{"start":{"line":79,"column":4},"end":{"line":80,"column":34}},"64":{"start":{"line":80,"column":8},"end":{"line":80,"column":34}},"65":{"start":{"line":81,"column":30},"end":{"line":81,"column":36}},"66":{"start":{"line":82,"column":24},"end":{"line":82,"column":62}},"67":{"start":{"line":83,"column":4},"end":{"line":87,"column":8}},"68":{"start":{"line":88,"column":4},"end":{"line":88,"column":35}},"69":{"start":{"line":90,"column":0},"end":{"line":90,"column":40}},"70":{"start":{"line":91,"column":25},"end":{"line":126,"column":2}},"71":{"start":{"line":91,"column":61},"end":{"line":126,"column":2}},"72":{"start":{"line":92,"column":4},"end":{"line":93,"column":34}},"73":{"start":{"line":93,"column":8},"end":{"line":93,"column":34}},"74":{"start":{"line":94,"column":21},"end":{"line":94,"column":57}},"75":{"start":{"line":95,"column":16},"end":{"line":95,"column":54}},"76":{"start":{"line":97,"column":20},"end":{"line":100,"column":5}},"77":{"start":{"line":101,"column":4},"end":{"line":108,"column":5}},"78":{"start":{"line":102,"column":8},"end":{"line":102,"column":90}},"79":{"start":{"line":105,"column":8},"end":{"line":105,"column":109}},"80":{"start":{"line":106,"column":8},"end":{"line":106,"column":39}},"81":{"start":{"line":107,"column":8},"end":{"line":107,"column":90}},"82":{"start":{"line":109,"column":4},"end":{"line":110,"column":38}},"83":{"start":{"line":110,"column":8},"end":{"line":110,"column":38}},"84":{"start":{"line":111,"column":26},"end":{"line":111,"column":51}},"85":{"start":{"line":112,"column":4},"end":{"line":113,"column":24}},"86":{"start":{"line":113,"column":8},"end":{"line":113,"column":24}},"87":{"start":{"line":114,"column":4},"end":{"line":125,"column":8}},"88":{"start":{"line":116,"column":12},"end":{"line":116,"column":101}},"89":{"start":{"line":117,"column":12},"end":{"line":117,"column":75}},"90":{"start":{"line":120,"column":12},"end":{"line":120,"column":29}},"91":{"start":{"line":123,"column":12},"end":{"line":123,"column":22}},"92":{"start":{"line":127,"column":0},"end":{"line":127,"column":44}},"93":{"start":{"line":128,"column":25},"end":{"line":152,"column":2}},"94":{"start":{"line":128,"column":36},"end":{"line":152,"column":2}},"95":{"start":{"line":130,"column":4},"end":{"line":131,"column":34}},"96":{"start":{"line":131,"column":8},"end":{"line":131,"column":34}},"97":{"start":{"line":132,"column":19},"end":{"line":132,"column":39}},"98":{"start":{"line":133,"column":23},"end":{"line":133,"column":125}},"99":{"start":{"line":134,"column":4},"end":{"line":135,"column":41}},"100":{"start":{"line":135,"column":8},"end":{"line":135,"column":41}},"101":{"start":{"line":136,"column":4},"end":{"line":151,"column":5}},"102":{"start":{"line":137,"column":8},"end":{"line":143,"column":9}},"103":{"start":{"line":137,"column":22},"end":{"line":137,"column":26}},"104":{"start":{"line":137,"column":33},"end":{"line":137,"column":67}},"105":{"start":{"line":138,"column":12},"end":{"line":138,"column":26}},"106":{"start":{"line":139,"column":12},"end":{"line":139,"column":23}},"107":{"start":{"line":140,"column":28},"end":{"line":140,"column":30}},"108":{"start":{"line":141,"column":28},"end":{"line":141,"column":62}},"109":{"start":{"line":142,"column":12},"end":{"line":142,"column":86}},"110":{"start":{"line":145,"column":20},"end":{"line":145,"column":43}},"111":{"start":{"line":147,"column":8},"end":{"line":150,"column":45}},"112":{"start":{"line":148,"column":12},"end":{"line":148,"column":66}},"113":{"start":{"line":148,"column":48},"end":{"line":148,"column":66}},"114":{"start":{"line":150,"column":18},"end":{"line":150,"column":43}},"115":{"start":{"line":150,"column":27},"end":{"line":150,"column":43}},"116":{"start":{"line":153,"column":0},"end":{"line":153,"column":44}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":2,"column":44},"end":{"line":2,"column":45}},"loc":{"start":{"line":2,"column":89},"end":{"line":10,"column":1}},"line":2},"1":{"name":"adopt","decl":{"start":{"line":3,"column":13},"end":{"line":3,"column":18}},"loc":{"start":{"line":3,"column":26},"end":{"line":3,"column":112}},"line":3},"2":{"name":"(anonymous_2)","decl":{"start":{"line":3,"column":70},"end":{"line":3,"column":71}},"loc":{"start":{"line":3,"column":89},"end":{"line":3,"column":108}},"line":3},"3":{"name":"(anonymous_3)","decl":{"start":{"line":4,"column":36},"end":{"line":4,"column":37}},"loc":{"start":{"line":4,"column":63},"end":{"line":9,"column":5}},"line":4},"4":{"name":"fulfilled","decl":{"start":{"line":5,"column":17},"end":{"line":5,"column":26}},"loc":{"start":{"line":5,"column":34},"end":{"line":5,"column":99}},"line":5},"5":{"name":"rejected","decl":{"start":{"line":6,"column":17},"end":{"line":6,"column":25}},"loc":{"start":{"line":6,"column":33},"end":{"line":6,"column":102}},"line":6},"6":{"name":"step","decl":{"start":{"line":7,"column":17},"end":{"line":7,"column":21}},"loc":{"start":{"line":7,"column":30},"end":{"line":7,"column":118}},"line":7},"7":{"name":"(anonymous_7)","decl":{"start":{"line":11,"column":52},"end":{"line":11,"column":53}},"loc":{"start":{"line":11,"column":65},"end":{"line":17,"column":1}},"line":11},"8":{"name":"(anonymous_8)","decl":{"start":{"line":14,"column":180},"end":{"line":14,"column":181}},"loc":{"start":{"line":14,"column":192},"end":{"line":14,"column":208}},"line":14},"9":{"name":"verb","decl":{"start":{"line":15,"column":13},"end":{"line":15,"column":17}},"loc":{"start":{"line":15,"column":21},"end":{"line":15,"column":164}},"line":15},"10":{"name":"(anonymous_10)","decl":{"start":{"line":15,"column":38},"end":{"line":15,"column":39}},"loc":{"start":{"line":15,"column":51},"end":{"line":15,"column":161}},"line":15},"11":{"name":"(anonymous_11)","decl":{"start":{"line":15,"column":72},"end":{"line":15,"column":73}},"loc":{"start":{"line":15,"column":99},"end":{"line":15,"column":157}},"line":15},"12":{"name":"settle","decl":{"start":{"line":16,"column":13},"end":{"line":16,"column":19}},"loc":{"start":{"line":16,"column":43},"end":{"line":16,"column":128}},"line":16},"13":{"name":"(anonymous_13)","decl":{"start":{"line":16,"column":69},"end":{"line":16,"column":70}},"loc":{"start":{"line":16,"column":81},"end":{"line":16,"column":116}},"line":16},"14":{"name":"(anonymous_14)","decl":{"start":{"line":18,"column":56},"end":{"line":18,"column":57}},"loc":{"start":{"line":18,"column":71},"end":{"line":20,"column":1}},"line":18},"15":{"name":"(anonymous_15)","decl":{"start":{"line":43,"column":25},"end":{"line":43,"column":26}},"loc":{"start":{"line":43,"column":37},"end":{"line":77,"column":2}},"line":43},"16":{"name":"(anonymous_16)","decl":{"start":{"line":43,"column":71},"end":{"line":43,"column":72}},"loc":{"start":{"line":43,"column":84},"end":{"line":77,"column":1}},"line":43},"17":{"name":"(anonymous_17)","decl":{"start":{"line":78,"column":23},"end":{"line":78,"column":24}},"loc":{"start":{"line":78,"column":51},"end":{"line":89,"column":2}},"line":78},"18":{"name":"(anonymous_18)","decl":{"start":{"line":78,"column":85},"end":{"line":78,"column":86}},"loc":{"start":{"line":78,"column":98},"end":{"line":89,"column":1}},"line":78},"19":{"name":"(anonymous_19)","decl":{"start":{"line":91,"column":25},"end":{"line":91,"column":26}},"loc":{"start":{"line":91,"column":61},"end":{"line":126,"column":2}},"line":91},"20":{"name":"(anonymous_20)","decl":{"start":{"line":91,"column":95},"end":{"line":91,"column":96}},"loc":{"start":{"line":91,"column":108},"end":{"line":126,"column":1}},"line":91},"21":{"name":"(anonymous_21)","decl":{"start":{"line":115,"column":8},"end":{"line":115,"column":9}},"loc":{"start":{"line":115,"column":16},"end":{"line":118,"column":9}},"line":115},"22":{"name":"(anonymous_22)","decl":{"start":{"line":119,"column":8},"end":{"line":119,"column":9}},"loc":{"start":{"line":119,"column":21},"end":{"line":121,"column":9}},"line":119},"23":{"name":"(anonymous_23)","decl":{"start":{"line":122,"column":8},"end":{"line":122,"column":9}},"loc":{"start":{"line":122,"column":16},"end":{"line":124,"column":9}},"line":122},"24":{"name":"(anonymous_24)","decl":{"start":{"line":128,"column":25},"end":{"line":128,"column":26}},"loc":{"start":{"line":128,"column":36},"end":{"line":152,"column":2}},"line":128},"25":{"name":"(anonymous_25)","decl":{"start":{"line":128,"column":70},"end":{"line":128,"column":71}},"loc":{"start":{"line":128,"column":83},"end":{"line":152,"column":1}},"line":128}},"branchMap":{"0":{"loc":{"start":{"line":2,"column":16},"end":{"line":10,"column":1}},"type":"binary-expr","locations":[{"start":{"line":2,"column":17},"end":{"line":2,"column":21}},{"start":{"line":2,"column":25},"end":{"line":2,"column":39}},{"start":{"line":2,"column":44},"end":{"line":10,"column":1}}],"line":2},"1":{"loc":{"start":{"line":3,"column":35},"end":{"line":3,"column":109}},"type":"cond-expr","locations":[{"start":{"line":3,"column":56},"end":{"line":3,"column":61}},{"start":{"line":3,"column":64},"end":{"line":3,"column":109}}],"line":3},"2":{"loc":{"start":{"line":4,"column":16},"end":{"line":4,"column":34}},"type":"binary-expr","locations":[{"start":{"line":4,"column":16},"end":{"line":4,"column":17}},{"start":{"line":4,"column":22},"end":{"line":4,"column":33}}],"line":4},"3":{"loc":{"start":{"line":7,"column":32},"end":{"line":7,"column":115}},"type":"cond-expr","locations":[{"start":{"line":7,"column":46},"end":{"line":7,"column":67}},{"start":{"line":7,"column":70},"end":{"line":7,"column":115}}],"line":7},"4":{"loc":{"start":{"line":8,"column":51},"end":{"line":8,"column":67}},"type":"binary-expr","locations":[{"start":{"line":8,"column":51},"end":{"line":8,"column":61}},{"start":{"line":8,"column":65},"end":{"line":8,"column":67}}],"line":8},"5":{"loc":{"start":{"line":11,"column":20},"end":{"line":17,"column":1}},"type":"binary-expr","locations":[{"start":{"line":11,"column":21},"end":{"line":11,"column":25}},{"start":{"line":11,"column":29},"end":{"line":11,"column":47}},{"start":{"line":11,"column":52},"end":{"line":17,"column":1}}],"line":11},"6":{"loc":{"start":{"line":12,"column":4},"end":{"line":12,"column":91}},"type":"if","locations":[{"start":{"line":12,"column":4},"end":{"line":12,"column":91}},{"start":{"line":12,"column":4},"end":{"line":12,"column":91}}],"line":12},"7":{"loc":{"start":{"line":14,"column":11},"end":{"line":14,"column":212}},"type":"cond-expr","locations":[{"start":{"line":14,"column":15},"end":{"line":14,"column":24}},{"start":{"line":14,"column":28},"end":{"line":14,"column":211}}],"line":14},"8":{"loc":{"start":{"line":14,"column":32},"end":{"line":14,"column":99}},"type":"cond-expr","locations":[{"start":{"line":14,"column":65},"end":{"line":14,"column":76}},{"start":{"line":14,"column":79},"end":{"line":14,"column":99}}],"line":14},"9":{"loc":{"start":{"line":15,"column":30},"end":{"line":15,"column":161}},"type":"binary-expr","locations":[{"start":{"line":15,"column":30},"end":{"line":15,"column":34}},{"start":{"line":15,"column":38},"end":{"line":15,"column":161}}],"line":15},"10":{"loc":{"start":{"line":18,"column":22},"end":{"line":20,"column":1}},"type":"binary-expr","locations":[{"start":{"line":18,"column":23},"end":{"line":18,"column":27}},{"start":{"line":18,"column":31},"end":{"line":18,"column":51}},{"start":{"line":18,"column":56},"end":{"line":20,"column":1}}],"line":18},"11":{"loc":{"start":{"line":19,"column":11},"end":{"line":19,"column":61}},"type":"cond-expr","locations":[{"start":{"line":19,"column":37},"end":{"line":19,"column":40}},{"start":{"line":19,"column":43},"end":{"line":19,"column":61}}],"line":19},"12":{"loc":{"start":{"line":19,"column":12},"end":{"line":19,"column":33}},"type":"binary-expr","locations":[{"start":{"line":19,"column":12},"end":{"line":19,"column":15}},{"start":{"line":19,"column":19},"end":{"line":19,"column":33}}],"line":19},"13":{"loc":{"start":{"line":28,"column":105},"end":{"line":28,"column":128}},"type":"cond-expr","locations":[{"start":{"line":28,"column":121},"end":{"line":28,"column":123}},{"start":{"line":28,"column":126},"end":{"line":28,"column":128}}],"line":28},"14":{"loc":{"start":{"line":28,"column":191},"end":{"line":28,"column":214}},"type":"cond-expr","locations":[{"start":{"line":28,"column":207},"end":{"line":28,"column":209}},{"start":{"line":28,"column":212},"end":{"line":28,"column":214}}],"line":28},"15":{"loc":{"start":{"line":29,"column":0},"end":{"line":42,"column":1}},"type":"if","locations":[{"start":{"line":29,"column":0},"end":{"line":42,"column":1}},{"start":{"line":29,"column":0},"end":{"line":42,"column":1}}],"line":29},"16":{"loc":{"start":{"line":46,"column":4},"end":{"line":47,"column":34}},"type":"if","locations":[{"start":{"line":46,"column":4},"end":{"line":47,"column":34}},{"start":{"line":46,"column":4},"end":{"line":47,"column":34}}],"line":46},"17":{"loc":{"start":{"line":46,"column":8},"end":{"line":46,"column":47}},"type":"binary-expr","locations":[{"start":{"line":46,"column":8},"end":{"line":46,"column":26}},{"start":{"line":46,"column":30},"end":{"line":46,"column":47}}],"line":46},"18":{"loc":{"start":{"line":53,"column":23},"end":{"line":53,"column":106}},"type":"cond-expr","locations":[{"start":{"line":53,"column":72},"end":{"line":53,"column":78}},{"start":{"line":53,"column":81},"end":{"line":53,"column":106}}],"line":53},"19":{"loc":{"start":{"line":53,"column":23},"end":{"line":53,"column":69}},"type":"binary-expr","locations":[{"start":{"line":53,"column":23},"end":{"line":53,"column":52}},{"start":{"line":53,"column":56},"end":{"line":53,"column":69}}],"line":53},"20":{"loc":{"start":{"line":54,"column":4},"end":{"line":55,"column":37}},"type":"if","locations":[{"start":{"line":54,"column":4},"end":{"line":55,"column":37}},{"start":{"line":54,"column":4},"end":{"line":55,"column":37}}],"line":54},"21":{"loc":{"start":{"line":73,"column":12},"end":{"line":73,"column":92}},"type":"if","locations":[{"start":{"line":73,"column":12},"end":{"line":73,"column":92}},{"start":{"line":73,"column":12},"end":{"line":73,"column":92}}],"line":73},"22":{"loc":{"start":{"line":73,"column":16},"end":{"line":73,"column":59}},"type":"binary-expr","locations":[{"start":{"line":73,"column":16},"end":{"line":73,"column":19}},{"start":{"line":73,"column":23},"end":{"line":73,"column":26}},{"start":{"line":73,"column":31},"end":{"line":73,"column":58}}],"line":73},"23":{"loc":{"start":{"line":75,"column":18},"end":{"line":75,"column":43}},"type":"if","locations":[{"start":{"line":75,"column":18},"end":{"line":75,"column":43}},{"start":{"line":75,"column":18},"end":{"line":75,"column":43}}],"line":75},"24":{"loc":{"start":{"line":79,"column":4},"end":{"line":80,"column":34}},"type":"if","locations":[{"start":{"line":79,"column":4},"end":{"line":80,"column":34}},{"start":{"line":79,"column":4},"end":{"line":80,"column":34}}],"line":79},"25":{"loc":{"start":{"line":79,"column":8},"end":{"line":79,"column":47}},"type":"binary-expr","locations":[{"start":{"line":79,"column":8},"end":{"line":79,"column":26}},{"start":{"line":79,"column":30},"end":{"line":79,"column":47}}],"line":79},"26":{"loc":{"start":{"line":92,"column":4},"end":{"line":93,"column":34}},"type":"if","locations":[{"start":{"line":92,"column":4},"end":{"line":93,"column":34}},{"start":{"line":92,"column":4},"end":{"line":93,"column":34}}],"line":92},"27":{"loc":{"start":{"line":92,"column":8},"end":{"line":92,"column":47}},"type":"binary-expr","locations":[{"start":{"line":92,"column":8},"end":{"line":92,"column":26}},{"start":{"line":92,"column":30},"end":{"line":92,"column":47}}],"line":92},"28":{"loc":{"start":{"line":94,"column":21},"end":{"line":94,"column":57}},"type":"binary-expr","locations":[{"start":{"line":94,"column":21},"end":{"line":94,"column":38}},{"start":{"line":94,"column":42},"end":{"line":94,"column":57}}],"line":94},"29":{"loc":{"start":{"line":109,"column":4},"end":{"line":110,"column":38}},"type":"if","locations":[{"start":{"line":109,"column":4},"end":{"line":110,"column":38}},{"start":{"line":109,"column":4},"end":{"line":110,"column":38}}],"line":109},"30":{"loc":{"start":{"line":112,"column":4},"end":{"line":113,"column":24}},"type":"if","locations":[{"start":{"line":112,"column":4},"end":{"line":113,"column":24}},{"start":{"line":112,"column":4},"end":{"line":113,"column":24}}],"line":112},"31":{"loc":{"start":{"line":130,"column":4},"end":{"line":131,"column":34}},"type":"if","locations":[{"start":{"line":130,"column":4},"end":{"line":131,"column":34}},{"start":{"line":130,"column":4},"end":{"line":131,"column":34}}],"line":130},"32":{"loc":{"start":{"line":130,"column":8},"end":{"line":130,"column":47}},"type":"binary-expr","locations":[{"start":{"line":130,"column":8},"end":{"line":130,"column":26}},{"start":{"line":130,"column":30},"end":{"line":130,"column":47}}],"line":130},"33":{"loc":{"start":{"line":134,"column":4},"end":{"line":135,"column":41}},"type":"if","locations":[{"start":{"line":134,"column":4},"end":{"line":135,"column":41}},{"start":{"line":134,"column":4},"end":{"line":135,"column":41}}],"line":134},"34":{"loc":{"start":{"line":134,"column":8},"end":{"line":134,"column":43}},"type":"binary-expr","locations":[{"start":{"line":134,"column":8},"end":{"line":134,"column":19}},{"start":{"line":134,"column":23},"end":{"line":134,"column":43}}],"line":134},"35":{"loc":{"start":{"line":148,"column":12},"end":{"line":148,"column":66}},"type":"if","locations":[{"start":{"line":148,"column":12},"end":{"line":148,"column":66}},{"start":{"line":148,"column":12},"end":{"line":148,"column":66}}],"line":148},"36":{"loc":{"start":{"line":148,"column":16},"end":{"line":148,"column":46}},"type":"binary-expr","locations":[{"start":{"line":148,"column":16},"end":{"line":148,"column":19}},{"start":{"line":148,"column":23},"end":{"line":148,"column":26}},{"start":{"line":148,"column":31},"end":{"line":148,"column":45}}],"line":148},"37":{"loc":{"start":{"line":150,"column":18},"end":{"line":150,"column":43}},"type":"if","locations":[{"start":{"line":150,"column":18},"end":{"line":150,"column":43}},{"start":{"line":150,"column":18},"end":{"line":150,"column":43}}],"line":150}},"s":{"0":1,"1":19,"2":0,"3":6,"4":18,"5":18,"6":0,"7":0,"8":0,"9":0,"10":24,"11":6,"12":1,"13":2,"14":0,"15":2,"16":2,"17":0,"18":6,"19":4,"20":4,"21":4,"22":4,"23":1,"24":1,"25":1,"26":1,"27":1,"28":1,"29":1,"30":1,"31":1,"32":1,"33":1,"34":1,"35":0,"36":1,"37":1,"38":1,"39":0,"40":1,"41":1,"42":1,"43":1,"44":0,"45":1,"46":1,"47":1,"48":1,"49":2,"50":2,"51":2,"52":2,"53":2,"54":2,"55":0,"56":1,"57":1,"58":0,"59":1,"60":0,"61":1,"62":1,"63":1,"64":0,"65":1,"66":1,"67":1,"68":1,"69":1,"70":1,"71":3,"72":3,"73":0,"74":3,"75":3,"76":3,"77":3,"78":3,"79":0,"80":0,"81":0,"82":3,"83":0,"84":3,"85":3,"86":0,"87":3,"88":3,"89":3,"90":3,"91":3,"92":1,"93":1,"94":1,"95":1,"96":0,"97":1,"98":1,"99":1,"100":0,"101":1,"102":1,"103":1,"104":1,"105":1,"106":1,"107":1,"108":1,"109":1,"110":0,"111":0,"112":0,"113":0,"114":0,"115":0,"116":1},"f":{"0":6,"1":19,"2":0,"3":6,"4":18,"5":0,"6":24,"7":2,"8":0,"9":6,"10":4,"11":4,"12":4,"13":4,"14":1,"15":1,"16":1,"17":1,"18":1,"19":3,"20":3,"21":3,"22":3,"23":3,"24":1,"25":1},"b":{"0":[1,1,1],"1":[19,0],"2":[6,6],"3":[5,19],"4":[6,6],"5":[1,1,1],"6":[0,2],"7":[0,2],"8":[2,0],"9":[6,2],"10":[1,1,1],"11":[0,1],"12":[1,1],"13":[0,1],"14":[0,1],"15":[1,0],"16":[0,1],"17":[1,1],"18":[0,1],"19":[1,1],"20":[0,1],"21":[0,1],"22":[1,0,0],"23":[0,1],"24":[0,1],"25":[1,1],"26":[0,3],"27":[3,3],"28":[3,1],"29":[0,3],"30":[0,3],"31":[0,1],"32":[1,1],"33":[0,1],"34":[1,1],"35":[0,0],"36":[0,0,0],"37":[0,0]},"inputSourceMap":{"version":3,"file":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/storage/s3.ts","sources":["/mnt/ironwolf2tb/moreillon/dev/node/image_manager/storage/s3.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AAAA,kDAM2B;AAC3B,gDAAuB;AAGvB,2BAAiC;AACjC,oCAAwC;AAE3B,KAMT,OAAO,CAAC,GAAG,EALb,iBAAS,iBACT,wBAAqB,EAArB,wBAAgB,mBAAG,EAAE,OACrB,4BAAyB,EAAzB,4BAAoB,mBAAG,EAAE,OACzB,mBAAW,mBACX,iBAAS,gBACI;AAIf,IAAI,iBAAS,EAAE;IACb,OAAO,CAAC,GAAG,CAAC,6CAA6C,iBAAS,GAAG,CAAC,CAAA;IACtE,gBAAQ,GAAG,IAAI,oBAAQ,CAAC;QACtB,MAAM,EAAE,iBAAS;QACjB,WAAW,EAAE;YACX,WAAW,EAAE,wBAAgB;YAC7B,eAAe,EAAE,4BAAoB;SACtC;QACD,QAAQ,EAAE,mBAAW;KACtB,CAAC,CAAA;CACH;KAAM;IACL,OAAO,CAAC,GAAG,CAAC,yDAAyD,CAAC,CAAA;CACvE;AAED,MAAM,gBAAgB,GAAG,CAAO,MAAiB,EAAE,EAAE;;;IACnD,IAAI,CAAC,iBAAS,IAAI,CAAC,gBAAQ;QAAE,MAAM,mBAAmB,CAAA;IAEtD,MAAM,OAAO,GAAG;QACd,MAAM,EAAE,iBAAS;QACjB,GAAG,EAAE,GAAG,MAAM,CAAC,GAAG,CAAC,QAAQ,EAAE,IAAI,MAAM,CAAC,QAAQ,EAAE;KACnD,CAAA;IAED,MAAM,QAAQ,GAAG,MAAM,gBAAQ,CAAC,IAAI,CAAC,IAAI,4BAAgB,CAAC,OAAO,CAAC,CAAC,CAAA;IACnE,MAAM,GAAG,GAAG,MAAM,CAAA,MAAA,QAAQ,CAAC,IAAI,0CAAE,oBAAoB,EAAE,CAAA,CAAA;IACvD,IAAI,CAAC,GAAG;QAAE,MAAM,sBAAsB,CAAA;;QAEtC,KAA4B,eAAA,kBAAA,cAAA,qBAAa,CAAA,mBAAA,iGAAE;YAAf,6BAAa;YAAb,WAAa;YAA9B,MAAM,OAAO,KAAA,CAAA;YACtB,MAAM,WAAW,GAAG,MAAM,OAAO,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAA;YAC/C,MAAM,IAAI,GAAG,MAAM,WAAW,CAAC,QAAQ,EAAE,CAAA;YAEzC,MAAM,gBAAQ,CAAC,IAAI,CACjB,IAAI,4BAAgB,CAAC;gBACnB,GAAG,EAAE,GAAG,MAAM,CAAC,GAAG,CAAC,QAAQ,EAAE,IAAI,OAAO,CAAC,QAAQ,EAAE;gBACnD,MAAM,EAAE,iBAAS;gBACjB,IAAI;aACL,CAAC,CACH,CAAA;SACF;;;;;;;;;AACH,CAAC,CAAA,CAAA;AAEM,MAAM,cAAc,GAAG,CAC5B,cAAsB,EACtB,MAAiB,EACjB,EAAE;IACF,IAAI,CAAC,iBAAS,IAAI,CAAC,gBAAQ;QAAE,MAAM,mBAAmB,CAAA;IAEtD,MAAM,EAAE,GAAG,EAAE,QAAQ,EAAE,GAAG,MAAM,CAAA;IAEhC,MAAM,WAAW,GAAG,IAAA,iBAAY,EAAC,cAAc,CAAC,CAAA;IAEhD,MAAM,gBAAQ,CAAC,IAAI,CACjB,IAAI,4BAAgB,CAAC;QACnB,GAAG,EAAE,GAAG,GAAG,IAAI,QAAQ,EAAE;QACzB,MAAM,EAAE,iBAAS;QACjB,IAAI,EAAE,WAAW;KAClB,CAAC,CACH,CAAA;IAED,MAAM,gBAAgB,CAAC,MAAM,CAAC,CAAA;AAChC,CAAC,CAAA,CAAA;AAnBY,QAAA,cAAc,kBAmB1B;AAEM,MAAM,gBAAgB,GAAG,CAC9B,GAAa,EACb,MAAiB,EACjB,iBAA0B,EAC1B,EAAE;IACF,IAAI,CAAC,iBAAS,IAAI,CAAC,gBAAQ;QAAE,MAAM,mBAAmB,CAAA;IAEtD,MAAM,QAAQ,GAAG,iBAAiB,IAAI,MAAM,CAAC,QAAQ,CAAA;IACrD,MAAM,GAAG,GAAG,GAAG,MAAM,CAAC,GAAG,CAAC,QAAQ,EAAE,IAAI,QAAQ,EAAE,CAAA;IAElD,IAAI,QAAQ,CAAA;IACZ,MAAM,OAAO,GAAG;QACd,MAAM,EAAE,iBAAS;QACjB,GAAG;KACJ,CAAA;IACD,IAAI;QACF,QAAQ,GAAG,MAAM,gBAAQ,CAAC,IAAI,CAAC,IAAI,4BAAgB,CAAC,OAAO,CAAC,CAAC,CAAA;KAC9D;IAAC,OAAO,KAAK,EAAE;QACd,OAAO,CAAC,GAAG,CACT,yCAAyC,MAAM,CAAC,GAAG,CAAC,QAAQ,EAAE,yBAAyB,CACxF,CAAA;QACD,MAAM,gBAAgB,CAAC,MAAM,CAAC,CAAA;QAC9B,QAAQ,GAAG,MAAM,gBAAQ,CAAC,IAAI,CAAC,IAAI,4BAAgB,CAAC,OAAO,CAAC,CAAC,CAAA;KAC9D;IAED,IAAI,CAAC,QAAQ;QAAE,MAAM,uBAAuB,CAAA;IAE5C,MAAM,EAAE,IAAI,EAAE,GAAG,EAAE,GAAG,cAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA;IACrC,IAAI,CAAC,QAAQ,CAAC,IAAI;QAAE,MAAM,SAAS,CAAA;IACnC,QAAQ,CAAC,IAAI,CAAC,oBAAoB,EAAE,CAAC,MAAM,CACzC,IAAI,cAAc,CAAC;QACjB,KAAK;YACH,GAAG,CAAC,SAAS,CACX,qBAAqB,EACrB,wBAAwB,kBAAkB,CAAC,IAAI,CAAC,EAAE,CACnD,CAAA;YACD,GAAG,CAAC,SAAS,CAAC,cAAc,EAAE,SAAS,GAAG,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,CAAC,EAAE,CAAC,CAAA;QAChE,CAAC;QACD,KAAK,CAAC,KAAK;YACT,GAAG,CAAC,KAAK,CAAC,KAAK,CAAC,CAAA;QAClB,CAAC;QACD,KAAK;YACH,GAAG,CAAC,GAAG,EAAE,CAAA;QACX,CAAC;KACF,CAAC,CACH,CAAA;AACH,CAAC,CAAA,CAAA;AA9CY,QAAA,gBAAgB,oBA8C5B;AAEM,MAAM,gBAAgB,GAAG,CAAO,KAAgB,EAAE,EAAE;;IACzD,IAAI,CAAC,iBAAS,IAAI,CAAC,gBAAQ;QAAE,MAAM,mBAAmB,CAAA;IACtD,MAAM,MAAM,GAAG,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAA;IAEnC,MAAM,UAAU,GAAG,MAAM,gBAAQ,CAAC,IAAI,CACpC,IAAI,8BAAkB,CAAC,EAAE,MAAM,EAAE,iBAAS,EAAE,MAAM,EAAE,CAAC,CACtD,CAAA;IAED,IAAI,CAAC,UAAU,IAAI,CAAC,UAAU,CAAC,QAAQ;QAAE,MAAM,GAAG,MAAM,iBAAiB,CAAA;;QAEzE,KAA4B,eAAA,KAAA,cAAA,UAAU,CAAC,QAAQ,CAAA,IAAA,sDAAE;YAArB,cAAmB;YAAnB,WAAmB;YAApC,MAAM,EAAE,GAAG,EAAE,KAAA,CAAA;YACtB,MAAM,OAAO,GAAG,EAAE,GAAG,EAAE,MAAM,EAAE,iBAAS,EAAE,CAAA;YAC1C,MAAM,gBAAQ,CAAC,IAAI,CAAC,IAAI,+BAAmB,CAAC,OAAO,CAAC,CAAC,CAAA;SACtD;;;;;;;;;AACH,CAAC,CAAA,CAAA;AAdY,QAAA,gBAAgB,oBAc5B","sourcesContent":["import {\n  S3Client,\n  GetObjectCommand,\n  DeleteObjectCommand,\n  ListObjectsCommand,\n  PutObjectCommand,\n} from \"@aws-sdk/client-s3\"\nimport path from \"path\"\nimport { Response } from \"express\"\nimport { ImageType } from \"../models/image\"\nimport { readFileSync } from \"fs\"\nimport { imageVariants } from \"../utils\"\n\nexport const {\n  S3_REGION,\n  S3_ACCESS_KEY_ID = \"\",\n  S3_SECRET_ACCESS_KEY = \"\",\n  S3_ENDPOINT,\n  S3_BUCKET,\n} = process.env\n\nexport let s3Client: S3Client | undefined\n\nif (S3_BUCKET) {\n  console.log(`[Storage] S3_BUCKET is set, uploading to \"${S3_BUCKET}\"`)\n  s3Client = new S3Client({\n    region: S3_REGION,\n    credentials: {\n      accessKeyId: S3_ACCESS_KEY_ID,\n      secretAccessKey: S3_SECRET_ACCESS_KEY,\n    },\n    endpoint: S3_ENDPOINT,\n  })\n} else {\n  console.log(`[Storage] S3_BUCKET is NOT set, storing uploads locally`)\n}\n\nconst generateVariants = async (record: ImageType) => {\n  if (!S3_BUCKET || !s3Client) throw \"S3 not configured\"\n\n  const options = {\n    Bucket: S3_BUCKET,\n    Key: `${record._id.toString()}/${record.filename}`,\n  }\n\n  const response = await s3Client.send(new GetObjectCommand(options))\n  const buf = await response.Body?.transformToByteArray()\n  if (!buf) throw \"Failed to get Buffer\"\n\n  for await (const variant of imageVariants) {\n    const variantData = await variant.generate(buf)\n    const Body = await variantData.toBuffer()\n\n    await s3Client.send(\n      new PutObjectCommand({\n        Key: `${record._id.toString()}/${variant.filename}`,\n        Bucket: S3_BUCKET,\n        Body,\n      })\n    )\n  }\n}\n\nexport const storeImageToS3 = async (\n  tempUploadPath: string,\n  record: ImageType\n) => {\n  if (!S3_BUCKET || !s3Client) throw \"S3 not configured\"\n\n  const { _id, filename } = record\n\n  const imageBuffer = readFileSync(tempUploadPath)\n\n  await s3Client.send(\n    new PutObjectCommand({\n      Key: `${_id}/${filename}`,\n      Bucket: S3_BUCKET,\n      Body: imageBuffer,\n    })\n  )\n\n  await generateVariants(record)\n}\n\nexport const streamFileFromS3 = async (\n  res: Response,\n  record: ImageType,\n  specifiedFilename?: string\n) => {\n  if (!S3_BUCKET || !s3Client) throw \"S3 not configured\"\n\n  const filename = specifiedFilename || record.filename\n  const Key = `${record._id.toString()}/${filename}`\n\n  let response\n  const options = {\n    Bucket: S3_BUCKET,\n    Key,\n  }\n  try {\n    response = await s3Client.send(new GetObjectCommand(options))\n  } catch (error) {\n    console.log(\n      `One or more variant missing for image ${record._id.toString()}, regenerating files...`\n    )\n    await generateVariants(record)\n    response = await s3Client.send(new GetObjectCommand(options))\n  }\n\n  if (!response) throw `Fetching image failed`\n\n  const { base, ext } = path.parse(Key)\n  if (!response.Body) throw \"No Body\"\n  response.Body.transformToWebStream().pipeTo(\n    new WritableStream({\n      start() {\n        res.setHeader(\n          \"Content-Disposition\",\n          `attachment; filename=${encodeURIComponent(base)}`\n        )\n        res.setHeader(\"Content-Type\", `image/${ext.replace(\".\", \"\")}`)\n      },\n      write(chunk) {\n        res.write(chunk)\n      },\n      close() {\n        res.end()\n      },\n    })\n  )\n}\n\nexport const deleteFileFromS3 = async (image: ImageType) => {\n  if (!S3_BUCKET || !s3Client) throw \"S3 not configured\"\n  const Prefix = image._id.toString()\n\n  const objectList = await s3Client.send(\n    new ListObjectsCommand({ Bucket: S3_BUCKET, Prefix })\n  )\n\n  if (!objectList || !objectList.Contents) throw `${Prefix} has no content`\n\n  for await (const { Key } of objectList.Contents) {\n    const options = { Key, Bucket: S3_BUCKET }\n    await s3Client.send(new DeleteObjectCommand(options))\n  }\n}\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"107cbf9337e114b8d24a9112dd29e752a77367af","contentHash":"1e323b5f1403a4c79595538d98a0119cc0713c8d1d5b45862992e93e7265e9e4"},"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/routes/images.ts":{"path":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/routes/images.ts","statementMap":{"0":{"start":{"line":2,"column":22},"end":{"line":4,"column":1}},"1":{"start":{"line":3,"column":4},"end":{"line":3,"column":62}},"2":{"start":{"line":5,"column":0},"end":{"line":5,"column":62}},"3":{"start":{"line":6,"column":18},"end":{"line":6,"column":53}},"4":{"start":{"line":7,"column":17},"end":{"line":7,"column":49}},"5":{"start":{"line":8,"column":44},"end":{"line":8,"column":116}},"6":{"start":{"line":9,"column":21},"end":{"line":9,"column":60}},"7":{"start":{"line":10,"column":25},"end":{"line":10,"column":86}},"8":{"start":{"line":11,"column":15},"end":{"line":11,"column":41}},"9":{"start":{"line":12,"column":0},"end":{"line":15,"column":97}},"10":{"start":{"line":16,"column":0},"end":{"line":20,"column":106}},"11":{"start":{"line":21,"column":0},"end":{"line":21,"column":125}},"12":{"start":{"line":22,"column":0},"end":{"line":22,"column":122}},"13":{"start":{"line":23,"column":0},"end":{"line":23,"column":25}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":2,"column":56},"end":{"line":2,"column":57}},"loc":{"start":{"line":2,"column":71},"end":{"line":4,"column":1}},"line":2}},"branchMap":{"0":{"loc":{"start":{"line":2,"column":22},"end":{"line":4,"column":1}},"type":"binary-expr","locations":[{"start":{"line":2,"column":23},"end":{"line":2,"column":27}},{"start":{"line":2,"column":31},"end":{"line":2,"column":51}},{"start":{"line":2,"column":56},"end":{"line":4,"column":1}}],"line":2},"1":{"loc":{"start":{"line":3,"column":11},"end":{"line":3,"column":61}},"type":"cond-expr","locations":[{"start":{"line":3,"column":37},"end":{"line":3,"column":40}},{"start":{"line":3,"column":43},"end":{"line":3,"column":61}}],"line":3},"2":{"loc":{"start":{"line":3,"column":12},"end":{"line":3,"column":33}},"type":"binary-expr","locations":[{"start":{"line":3,"column":12},"end":{"line":3,"column":15}},{"start":{"line":3,"column":19},"end":{"line":3,"column":33}}],"line":3}},"s":{"0":1,"1":2,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1,"9":1,"10":1,"11":1,"12":1,"13":1},"f":{"0":2},"b":{"0":[1,1,1],"1":[0,2],"2":[2,2]},"inputSourceMap":{"version":3,"file":"/mnt/ironwolf2tb/moreillon/dev/node/image_manager/routes/images.ts","sources":["/mnt/ironwolf2tb/moreillon/dev/node/image_manager/routes/images.ts"],"names":[],"mappings":";;;;;AAAA,sDAAkE;AAClE,kDAO8B;AAC9B,qHAA+D;AAE/D,MAAM,YAAY,GAAG,EAAE,GAAG,EAAE,OAAO,CAAC,GAAG,CAAC,kBAAkB,EAAE,CAAA;AAC5D,MAAM,gBAAgB,mCAAQ,YAAY,KAAE,GAAG,EAAE,IAAI,GAAE,CAAA;AAEvD,MAAM,MAAM,GAAG,iBAAO,CAAC,MAAM,EAAE,CAAA;AAE/B,MAAM;KACH,KAAK,CAAC,GAAG,CAAC;KACV,GAAG,CAAC,IAAA,2CAAI,EAAC,YAAY,CAAC,EAAE,uBAAc,CAAC;KACvC,IAAI,CAAC,IAAA,2CAAI,EAAC,YAAY,CAAC,EAAE,qBAAY,CAAC,CAAA;AAEzC,MAAM;KACH,KAAK,CAAC,MAAM,CAAC;KACb,GAAG,CAAC,IAAA,2CAAI,EAAC,gBAAgB,CAAC,EAAE,kBAAS,CAAC;KACtC,MAAM,CAAC,IAAA,2CAAI,EAAC,YAAY,CAAC,EAAE,qBAAY,CAAC;KACxC,KAAK,CAAC,IAAA,2CAAI,EAAC,YAAY,CAAC,EAAE,6BAAoB,CAAC,CAAA;AAElD,MAAM,CAAC,KAAK,CAAC,cAAc,CAAC,CAAC,GAAG,CAAC,IAAA,2CAAI,EAAC,YAAY,CAAC,EAAE,0BAAiB,CAAC,CAAA;AAEvE,MAAM,CAAC,KAAK,CAAC,eAAe,CAAC,CAAC,GAAG,CAAC,IAAA,2CAAI,EAAC,gBAAgB,CAAC,EAAE,kBAAS,CAAC,CAAA;AAEpE,kBAAe,MAAM,CAAA","sourcesContent":["import express, { Request, Response, NextFunction } from \"express\"\r\nimport {\r\n  get_image_list,\r\n  upload_image,\r\n  get_image,\r\n  delete_image,\r\n  update_image_details,\r\n  get_image_details,\r\n} from \"../controllers/images\"\r\nimport auth from \"@moreillon/express_identification_middleware\"\r\n\r\nconst auth_options = { url: process.env.IDENTIFICATION_URL }\r\nconst auth_options_lax = { ...auth_options, lax: true }\r\n\r\nconst router = express.Router()\r\n\r\nrouter\r\n  .route(\"/\")\r\n  .get(auth(auth_options), get_image_list)\r\n  .post(auth(auth_options), upload_image)\r\n\r\nrouter\r\n  .route(\"/:id\")\r\n  .get(auth(auth_options_lax), get_image)\r\n  .delete(auth(auth_options), delete_image)\r\n  .patch(auth(auth_options), update_image_details)\r\n\r\nrouter.route(\"/:id/details\").get(auth(auth_options), get_image_details)\r\n\r\nrouter.route(\"/:id/:variant\").get(auth(auth_options_lax), get_image)\r\n\r\nexport default router\r\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"bc1d06da66803d548177875cb868766241a139b8","contentHash":"4bf3d8125c49ca0dde4ebed80738746a95e7ad595b958d4d368957f835eae9c3"}}